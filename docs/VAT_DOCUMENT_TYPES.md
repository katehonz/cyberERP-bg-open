# VAT Номенклатура на видовете документи - ЗДДС

## Съдържание

1. [Общ преглед](#общ-преглед)
2. [Видове документи за продажби](#видове-документи-за-продажби)
3. [Видове документи за покупки](#видове-документи-за-покупки)
4. [Операции при продажба](#операции-при-продажба)
5. [Операции при покупка](#операции-при-покупка)
6. [Имплементация](#имплементация)
7. [Използване в потребителския интерфейс](#използване-в-потребителския-интерфейс)
8. [API примери](#api-примери)

---

## Общ преглед

Системата поддържа пълна номенклатура на видовете документи според **Правилника за прилагане на ЗДДС (ППЗДДС) 2025**. Всяка фактура (продажба или покупка) трябва да има зададен вид документ, който определя как ще бъде отразена в ДДС дневниците и NAP файловете.

### Правна основа

- **ЗДДС** - Закон за данък върху добавената стойност
- **ППЗДДС 2025** - Правилник за прилагане на ЗДДС, актуализация 2025
- **Файлове POKUPKI.TXT и PRODAGBI.TXT** - Формат за подаване на ДДС дневници към НАП

### Задължително поле

Полето `vat_document_type` е **задължително** при създаване на:
- Фактури за продажби (`invoices`)
- Фактури от доставчици (`supplier_invoices`)

---

## Видове документи за продажби

Използват се в модула `CyberCore.Sales.Invoice` и дневника `vat_sales_register`.

| Код | Описание | Забележка |
|-----|----------|-----------|
| **01** | Фактура | Стандартна фактура за продажба |
| **02** | Дебитно известие | Корекция увеличаваща данъчната основа |
| **03** | Кредитно известие | Корекция намаляваща данъчната основа |
| **04** | Регистър на стоки под режим складиране (изпратени) | Стоки изпратени до друга държава членка |
| **07** | Митническа декларация/документ | Удостоверяващ приключване на митн. формалности |
| **09** | Протокол или друг документ | Други документи |
| **11** | Фактура - касова отчетност | За специалния режим на касова отчетност |
| **12** | Дебитно известие - касова отчетност | ДИ при касова отчетност |
| **13** | Кредитно известие - касова отчетност | КИ при касова отчетност |
| **23** | Кредитно известие по чл. 126б, ал. 1 ЗДДС | Специално КИ |
| **29** | Протокол по чл. 126б, ал. 2 и 7 ЗДДС | Специален протокол |
| **50** | Протокол за начисляване на изискуемия ДДС за горива | Компенсации за горива |
| **81** | Отчет за извършените продажби | Обобщен отчет |
| **82** | Отчет при специален ред на облагане | Специален режим |
| **83** | Отчет при предоставени компенсации за горива | Горива |
| **84** | Отчет за продажби на хляб | Специфични продукти |
| **85** | Отчет за продажби на брашно | Специфични продукти |
| **91** | Протокол за изискуемия данък по чл. 151в, ал. 3 | Касова отчетност |
| **93** | Протокол по чл. 151в, ал. 7 (не прилага спец. режим) | Касова отчетност |
| **94** | Протокол по чл. 151в, ал. 7 (прилага спец. режим) | Касова отчетност |
| **95** | Протокол за безвъзмездно предоставяне на хранителни стоки | Чл. 6, ал. 4, т. 4 ЗДДС |

### Ограничения

Следните кодове **НЕ МОГАТ** да се използват в дневник за продажби (PRODAGBI.TXT):
- `92` - само за покупки
- `05` - само за покупки

---

## Видове документи за покупки

Използват се в модула `CyberCore.Purchase.SupplierInvoice` и дневника `vat_purchase_register`.

| Код | Описание | Забележка |
|-----|----------|-----------|
| **01** | Фактура | Стандартна получена фактура |
| **02** | Дебитно известие | Получено ДИ |
| **03** | Кредитно известие | Получено КИ |
| **05** | Регистър на стоки под режим складиране (получени) | Стоки получени на територията на страната |
| **07** | Митническа декларация/документ | Митнически документ |
| **09** | Протокол или друг документ | Други документи |
| **11** | Фактура - касова отчетност | При касова отчетност |
| **12** | Дебитно известие - касова отчетност | ДИ при касова отчетност |
| **13** | Кредитно известие - касова отчетност | КИ при касова отчетност |
| **23** | Кредитно известие по чл. 126б, ал. 1 ЗДДС | Специално КИ |
| **92** | Протокол за данъчния кредит по чл. 151г, ал. 8 | Данъчен кредит |

### Ограничения

Следните кодове **НЕ МОГАТ** да се използват в дневник за покупки (POKUPKI.TXT):
- `04`, `50`, `81`, `82`, `83`, `84`, `85` - само за продажби

---

## Операции при продажба

Полето `vat_sales_operation` определя типа на продажбата според ЗДДС.

| Код | Описание |
|-----|----------|
| **0** | Друго |
| **1** | Данъчно събитие по чл. 25, ал. 2 или чл. 25, ал. 3 |
| **2** | Доставка на стока и/или услуга в страната |
| **3** | Вътреобщностна доставка на стоки (ВОД) |
| **4** | Експорт на стоки |
| **5** | Доставка на услуги с място на изпълнение извън страната |

**Забележка:** Това поле е опционално, но се препоръчва да се попълва за точно отчитане в ДДС дневниците.

---

## Операции при покупка

Полето `vat_purchase_operation` определя типа на покупката според ЗДДС.

| Код | Описание |
|-----|----------|
| **0** | Друго |
| **1** | Данъчно събитие - чл. 25, ал. 2 или чл. 25, ал. 3 |
| **2** | Получена стока и/или услуга от доставчик - регистрирано лице |
| **3** | Получени услуги от доставчик по чл. 21, ал. 2 ЗДДС |
| **4** | Получени стоки от доставчик по чл. 21, ал. 2 ЗДДС |

**Забележка:** Това поле е опционално.

---

## Имплементация

### Backend структура

#### Invoice (Продажби)

**Модул:** `CyberCore.Sales.Invoice`
**Файл:** `apps/cyber_core/lib/cyber_core/sales/invoice.ex`

```elixir
# Типове документи за ПРОДАЖБИ според ППЗДДС 2025
@vat_document_types %{
  "01" => "Фактура",
  "02" => "Дебитно известие",
  "03" => "Кредитно известие",
  # ... всички 22 кода
}

# Операции при продажба според ППЗДДС
@vat_sales_operations %{
  "0" => "Друго",
  "1" => "Данъчно събитие по чл. 25, ал. 2 или чл. 25, ал. 3",
  # ...
}

schema "invoices" do
  # ...
  field :vat_document_type, :string
  field :vat_sales_operation, :string
  field :vat_additional_data, :string
  # ...
end

def changeset(invoice, attrs) do
  invoice
  |> cast(attrs, [:vat_document_type, :vat_sales_operation, ...])
  |> validate_required([:vat_document_type, ...])
  |> validate_inclusion(:vat_document_type, Map.keys(@vat_document_types))
  # ...
end
```

#### SupplierInvoice (Покупки)

**Модул:** `CyberCore.Purchase.SupplierInvoice`
**Файл:** `apps/cyber_core/lib/cyber_core/purchase/supplier_invoice.ex`

```elixir
# Типове документи за ПОКУПКИ според ППЗДДС 2025
@vat_document_types %{
  "01" => "Фактура",
  "02" => "Дебитно известие",
  # ... всички 11 кода
}

# Операции при покупка според ППЗДДС
@vat_purchase_operations %{
  "0" => "Друго",
  "1" => "Данъчно събитие - чл. 25, ал. 2 или чл. 25, ал. 3",
  # ...
}

schema "supplier_invoices" do
  # ...
  field :vat_document_type, :string
  field :vat_purchase_operation, :string
  field :vat_additional_data, :text
  # ...
end

def changeset(invoice, attrs) do
  invoice
  |> cast(attrs, [:vat_document_type, :vat_purchase_operation, ...])
  |> validate_required([:vat_document_type, ...])
  |> validate_inclusion(:vat_document_type, Map.keys(@vat_document_types))
  # ...
end
```

### База данни

**Миграция:** `20251119193304_add_vat_fields_to_supplier_invoices.exs`

```elixir
def change do
  alter table(:supplier_invoices) do
    add :vat_document_type, :string
    add :vat_purchase_operation, :string
    add :vat_additional_data, :text
  end
end
```

**Забележка:** Таблицата `invoices` вече имаше тези полета от предишна версия.

---

## Използване в потребителския интерфейс

### Фактури за продажби

**URL:** http://localhost:4000/invoices

**Формуляр:** `apps/cyber_web/lib/cyber_web/live/invoice_live/index.ex`

При създаване или редактиране на фактура:

1. Кликнете "Нова фактура"
2. Попълнете основните данни (клиент, дата, и т.н.)
3. В секцията **"ДДС данни"** изберете:
   - **Вид документ** (задължително) - падащо меню с всички 22 вида
   - **Операция при продажба** (опционално)

```html
<select name="invoice[vat_document_type]" required>
  <option value="">Изберете вид документ...</option>
  <option value="01">01 - Фактура</option>
  <option value="02">02 - Дебитно известие</option>
  <!-- ... -->
</select>
```

**Стойност по подразбиране:** `01 - Фактура`

### Фактури от доставчици (Покупки)

**URL:** http://localhost:4000/supplier-invoices

**Формуляр:** `apps/cyber_web/lib/cyber_web/live/supplier_invoice_live/index.ex`

При създаване или редактиране на фактура от доставчик:

1. Кликнете "Нова фактура"
2. Попълнете основните данни (доставчик, дата, и т.н.)
3. В секцията **"ДДС данни (ЗДДС)"** изберете:
   - **Вид документ** (задължително) - падащо меню с всички 11 вида
   - **Операция при покупка** (опционално)

```html
<select name="supplier_invoice[vat_document_type]" required>
  <option value="">Изберете вид документ...</option>
  <option value="01">01 - Фактура</option>
  <option value="02">02 - Дебитно известие</option>
  <!-- ... -->
</select>
```

**Стойност по подразбиране:** `01 - Фактура`

---

## API примери

### Създаване на фактура за продажба

```bash
POST /api/invoices
Content-Type: application/json

{
  "invoice": {
    "contact_id": 1,
    "invoice_no": "INV-2025-001",
    "issue_date": "2025-11-19",
    "billing_name": "Клиент ООД",
    "billing_vat_number": "BG123456789",
    "vat_document_type": "01",
    "vat_sales_operation": "2"
  },
  "lines": [
    {
      "description": "Консултантски услуги",
      "quantity": "10.00",
      "unit_price": "100.00",
      "tax_rate": "20.00"
    }
  ]
}
```

**Отговор:**

```json
{
  "data": {
    "id": 123,
    "invoice_no": "INV-2025-001",
    "vat_document_type": "01",
    "vat_sales_operation": "2",
    "total_amount": "1200.00",
    "status": "draft"
  }
}
```

### Създаване на фактура от доставчик

```bash
POST /api/supplier-invoices
Content-Type: application/json

{
  "supplier_invoice": {
    "supplier_id": 5,
    "invoice_no": "SUPP-2025-001",
    "supplier_invoice_no": "FAC-12345",
    "invoice_date": "2025-11-19",
    "supplier_name": "Доставчик ЕООД",
    "supplier_vat_number": "BG987654321",
    "vat_document_type": "01",
    "vat_purchase_operation": "2"
  },
  "lines": [
    {
      "description": "Офис материали",
      "quantity": "5.00",
      "unit_price": "50.00",
      "tax_rate": "20.00"
    }
  ]
}
```

**Отговор:**

```json
{
  "data": {
    "id": 456,
    "invoice_no": "SUPP-2025-001",
    "supplier_invoice_no": "FAC-12345",
    "vat_document_type": "01",
    "vat_purchase_operation": "2",
    "total_amount": "300.00",
    "status": "draft"
  }
}
```

### Актуализиране на вида документ

```bash
PATCH /api/invoices/123
Content-Type: application/json

{
  "invoice": {
    "vat_document_type": "03",
    "vat_sales_operation": "2"
  }
}
```

---

## Валидации

### Задължителни полета

- `vat_document_type` - **Задължително** за всички фактури

### Ограничения

- `vat_document_type` трябва да е валиден код от номенклатурата
- За продажби: 22 валидни кода (01-04, 07, 09, 11-13, 23, 29, 50, 81-85, 91, 93-95)
- За покупки: 11 валидни кода (01-03, 05, 07, 09, 11-13, 23, 92)
- `vat_sales_operation` и `vat_purchase_operation` са опционални

### Примери за грешки

```json
{
  "errors": {
    "vat_document_type": ["can't be blank"]
  }
}
```

```json
{
  "errors": {
    "vat_document_type": ["is invalid"]
  }
}
```

---

## Експорт към НАП

При генериране на файлове за НАП (POKUPKI.TXT, PRODAGBI.TXT), полето `vat_document_type` се използва директно в полето **"Вид на документа"** според ППЗДДС.

### Пример запис в PRODAGBI.TXT

```
1  00000000001010520250000000000000120.00     20.00BG123456789  Клиент ООД...
```

Където позициите 77-78 съдържат кода `01` (Фактура).

### Пример запис в POKUPKI.TXT

```
1  00000000001010520250000000000000300.00     50.00BG987654321  Доставчик ЕООД...
```

Където позициите 77-78 съдържат кода `01` (Фактура).

---

## Често задавани въпроси (FAQ)

### 1. Кога използвам код 02 (Дебитно известие)?

Използвайте код `02`, когато издавате дебитно известие за корекция на данъчната основа **нагоре** (увеличаване на ДДС).

### 2. Кога използвам код 03 (Кредитно известие)?

Използвайте код `03`, когато издавате кредитно известие за корекция на данъчната основа **надолу** (намаляване на ДДС).

### 3. Какво е специалният режим на касова отчетност (кодове 11-13)?

Това са кодове за фирми, които прилагат специалния режим на касова отчетност по чл. 151а от ЗДДС. При този режим данъкът става изискуем при плащането, а не при издаването на фактурата.

### 4. Мога ли да променя вида документ след издаване на фактурата?

Това зависи от бизнес правилата на вашата фирма. Технически системата позволява промяна, но се препоръчва да не променяте вида документ след като фактурата е издадена и регистрирана в ДДС дневниците.

### 5. Какво е разликата между код 04 и 05?

- **Код 04** - Регистър на стоки **изпратени** от България до друга ЕС държава (използва се в продажби)
- **Код 05** - Регистър на стоки **получени** в България от друга ЕС държава (използва се в покупки)

### 6. Кога е задължително полето "Операция при продажба/покупка"?

Полето е **опционално**, но се препоръчва да се попълва за:
- ВОД (Вътреобщностни доставки) - операция `3`
- Експорт - операция `4`
- Доставки на услуги извън ЕС - операция `5`

---

## Автоматична номерация

Системата поддържа **автоматична номерация** на документи във формат **10 цифри с водеща нула** (например: 0000000001).

### Две отделни номерации

1. **Фактури за продажби** (кодове 01, 02, 03, 04, 07, 11-13, 23, 81-85, 95)
   - Настройка: `sales_invoice_next_number`
   - Пример: 0000000001, 0000000002, ...

2. **Протоколи ВОП** (кодове 09, 29, 50, 91-94)
   - Настройка: `vop_protocol_next_number`
   - Пример: 0000000001, 0000000002, ...

### Конфигуриране

**URL:** http://localhost:4000/settings → Секция "Номерация на документи"

За повече информация вижте [DOCUMENT_NUMBERING.md](./DOCUMENT_NUMBERING.md)

---

## Допълнителни ресурси

- [VAT-docs.md](./VAT-docs.md) - Пълна документация за ДДС системата
- [DOCUMENT_NUMBERING.md](./DOCUMENT_NUMBERING.md) - Автоматична номерация на документи
- [SAFT-docs.md](./SAFT-docs.md) - Документация за SAF-T export
- [IMPLEMENTATION-STATUS.md](./IMPLEMENTATION-STATUS.md) - Статус на имплементацията

---

**Последна актуализация:** 19 ноември 2025
**Версия:** 1.1
**Автор:** Cyber ERP Team
