# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞ SAF-T –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –≤ Cyber ERP

## –°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â –ø—Ä–µ–≥–ª–µ–¥](#–æ–±—â-–ø—Ä–µ–≥–ª–µ–¥)
2. [–ö–∞–∫–≤–æ –µ SAF-T](#–∫–∞–∫–≤–æ-–µ-saf-t)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ SAF-T —Ñ–∞–π–ª–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–Ω–∞-saf-t-—Ñ–∞–π–ª–∞)
4. [–†–∞–∑—à–∏—Ä–µ–Ω–∏ –ø–æ–ª–µ—Ç–∞ –≤ Contacts](#—Ä–∞–∑—à–∏—Ä–µ–Ω–∏-–ø–æ–ª–µ—Ç–∞-–≤-contacts)
5. [SAF-T –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä](#saf-t-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä)
6. [–¢–∏–ø–æ–≤–µ SAF-T —Ñ–∞–π–ª–æ–≤–µ](#—Ç–∏–ø–æ–≤–µ-saf-t-—Ñ–∞–π–ª–æ–≤–µ)
7. [–ü—Ä–∏–º–µ—Ä–∏ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞](#–ø—Ä–∏–º–µ—Ä–∏-–∑–∞-—É–ø–æ—Ç—Ä–µ–±–∞)
8. [–†–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏](#—Ä–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∏-–º–∞—Ç–µ—Ä–∏–∞–ª–∏)

---

## –û–±—â –ø—Ä–µ–≥–ª–µ–¥

SAF-T (Standard Audit File for Tax) –µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω –æ–¥–∏—Ç–µ–Ω —Ñ–∞–π–ª –∑–∞ –¥–∞–Ω—ä—á–Ω–∏ —Ü–µ–ª–∏, —Ä–∞–∑—Ä–∞–±–æ—Ç–µ–Ω –æ—Ç OECD.
–ë—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ –≤–µ—Ä—Å–∏—è –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞ –∑–∞ –ø–æ–¥–∞–≤–∞–Ω–µ –∫—ä–º –ù–∞—Ü–∏–æ–Ω–∞–ª–Ω–∞ –∞–≥–µ–Ω—Ü–∏—è –∑–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ (–ù–ê–ü) –∏ –≤–∫–ª—é—á–≤–∞:

- –°–º–µ—Ç–∫–æ–ø–ª–∞–Ω (Chart of Accounts)
- –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∏ (Customers & Suppliers)
- –ì–ª–∞–≤–Ω–∞ –∫–Ω–∏–≥–∞ (General Ledger)
- –ü—ä—Ä–≤–∏—á–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (Source Documents)
- –î–î–° –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–í–µ—Ä—Å–∏—è:** BG_SAFT_Schema_V_1.0.1
**Namespace:** `mf:nra:dgti:dxxxx:declaration:v1`

---

## –ö–∞–∫–≤–æ –µ SAF-T

### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:

- **–§–æ—Ä–º–∞—Ç:** XML
- **–ö–æ–¥–∏—Ä–æ–≤–∫–∞:** UTF-8
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç:** OECD SAF-T —Å –±—ä–ª–≥–∞—Ä—Å–∫–∏ —Ä–∞–∑—à–∏—Ä–µ–Ω–∏—è
- **–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω –æ—Ç:** –ù–ê–ü (–ù–∞—Ü–∏–æ–Ω–∞–ª–Ω–∞ –∞–≥–µ–Ω—Ü–∏—è –∑–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ)
- **–£–ø–æ—Ç—Ä–µ–±–∞:**
  - –î–∞–Ω—ä—á–Ω–∏ —Ä–µ–≤–∏–∑–∏–∏
  - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –î–î–° –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
  - –§–∏–Ω–∞–Ω—Å–æ–≤ –∫–æ–Ω—Ç—Ä–æ–ª

### –ü—Ä–µ–¥–∏–º—Å—Ç–≤–∞:

‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–∞–Ω —Ñ–æ—Ä–º–∞—Ç –∑–∞ —Ä–∞–∑–º—è–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω–∏
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç –ù–ê–ü
‚úÖ –ù–∞–º–∞–ª—è–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—Ç–∞ —Ç–µ–∂–µ—Å—Ç
‚úÖ –ü–æ–¥–ø–æ–º–∞–≥–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏—è –æ–±–º–µ–Ω —Å –¥–∞–Ω—ä—á–Ω–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏
‚úÖ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç (OECD —Å—Ç–∞–Ω–¥–∞—Ä—Ç)

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ SAF-T —Ñ–∞–π–ª–∞

### –û—Å–Ω–æ–≤–Ω–∏ —Å–µ–∫—Ü–∏–∏:

```xml
<nsSAFT:AuditFile>
  <nsSAFT:Header>                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ñ–∞–π–ª–∞ -->
  <nsSAFT:MasterFiles>               <!-- –†–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∏ –¥–∞–Ω–Ω–∏ -->
    <nsSAFT:GeneralLedgerAccounts>   <!-- –°–º–µ—Ç–∫–æ–ø–ª–∞–Ω -->
    <nsSAFT:Customers>               <!-- –ö–ª–∏–µ–Ω—Ç–∏ -->
    <nsSAFT:Suppliers>               <!-- –î–æ—Å—Ç–∞–≤—á–∏—Ü–∏ -->
  </nsSAFT:MasterFiles>
  <nsSAFT:GeneralLedgerEntries>      <!-- –°—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏ -->
  <nsSAFT:SourceDocuments>           <!-- –ü—ä—Ä–≤–∏—á–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ -->
    <nsSAFT:SalesInvoices>           <!-- –§–∞–∫—Ç—É—Ä–∏ –ø—Ä–æ–¥–∞–∂–±–∏ -->
    <nsSAFT:PurchaseInvoices>        <!-- –§–∞–∫—Ç—É—Ä–∏ –ø–æ–∫—É–ø–∫–∏ -->
    <nsSAFT:Payments>                <!-- –ü–ª–∞—â–∞–Ω–∏—è -->
  </nsSAFT:SourceDocuments>
</nsSAFT:AuditFile>
```

### Header (–ó–∞–≥–ª–∞–≤–Ω–∞ —á–∞—Å—Ç):

```xml
<nsSAFT:Header>
  <nsSAFT:AuditFileVersion>007</nsSAFT:AuditFileVersion>
  <nsSAFT:AuditFileCountry>BG</nsSAFT:AuditFileCountry>
  <nsSAFT:AuditFileRegion>BG-22</nsSAFT:AuditFileRegion>
  <nsSAFT:AuditFileDateCreated>2025-10-11</nsSAFT:AuditFileDateCreated>
  <nsSAFT:SoftwareCompanyName>Cyber ERP</nsSAFT:SoftwareCompanyName>
  <nsSAFT:SoftwareID>CyberERP</nsSAFT:SoftwareID>
  <nsSAFT:SoftwareVersion>1.0</nsSAFT:SoftwareVersion>

  <nsSAFT:Company>
    <nsSAFT:RegistrationNumber>123456789</nsSAFT:RegistrationNumber>
    <nsSAFT:Name>–ú–æ—è—Ç–∞ —Ñ–∏—Ä–º–∞ –ï–û–û–î</nsSAFT:Name>
    <nsSAFT:TaxRegistration>
      <nsSAFT:TaxNumber>BG123456789</nsSAFT:TaxNumber>
    </nsSAFT:TaxRegistration>
  </nsSAFT:Company>

  <nsSAFT:SelectionCriteria>
    <nsSAFT:PeriodStart>10</nsSAFT:PeriodStart>
    <nsSAFT:PeriodStartYear>2025</nsSAFT:PeriodStartYear>
    <nsSAFT:PeriodEnd>10</nsSAFT:PeriodEnd>
    <nsSAFT:PeriodEndYear>2025</nsSAFT:PeriodEndYear>
  </nsSAFT:SelectionCriteria>

  <nsSAFT:TaxAccountingBasis>A</nsSAFT:TaxAccountingBasis>
</nsSAFT:Header>
```

**TaxAccountingBasis —Å—Ç–æ–π–Ω–æ—Å—Ç–∏:**
- `A` - General commercial entities (–¢—ä—Ä–≥–æ–≤—Å–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è)
- `P` - Public/government entities (–ë—é–¥–∂–µ—Ç–Ω–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è)
- `BANK` - –ë–∞–Ω–∫–∏
- `INSURANCE` - –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç–µ–ª–Ω–∏ –¥—Ä—É–∂–µ—Å—Ç–≤–∞

---

## –†–∞–∑—à–∏—Ä–µ–Ω–∏ –ø–æ–ª–µ—Ç–∞ –≤ Contacts

–¢–∞–±–ª–∏—Ü–∞—Ç–∞ `contacts` –µ —Ä–∞–∑—à–∏—Ä–µ–Ω–∞ —Å –≤—Å–∏—á–∫–∏ SAF-T –ø–æ–ª–µ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ XML —Ñ–∞–π–ª–∞.

### –ù–æ–≤–∏ –ø–æ–ª–µ—Ç–∞:

#### –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
```elixir
field :registration_number, :string    # –ï–ò–ö/–ë–£–õ–°–¢–ê–¢
field :vat_number, :string              # –î–î–° –Ω–æ–º–µ—Ä (BGxxxxxxxxx)
field :tax_type, :string                # –í–∏–¥ –¥–∞–Ω—ä–∫ (100010 –∑–∞ –î–î–°)
```

#### –ê–¥—Ä–µ—Å–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
```elixir
field :street_name, :string
field :building_number, :string
field :postal_code, :string
field :region, :string                  # BG-22, BG-01, –∏ —Ç.–Ω.
field :additional_address_detail, :string
field :building, :string
```

#### –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ –ª–∏—Ü–µ:
```elixir
field :contact_person_title, :string
field :contact_person_first_name, :string
field :contact_person_last_name, :string
field :fax, :string
field :website, :string
```

#### –ö–ª–∞—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:
```elixir
field :is_supplier, :boolean            # –î–æ—Å—Ç–∞–≤—á–∏–∫
field :is_customer, :boolean            # –ö–ª–∏–µ–Ω—Ç
field :self_billing_indicator, :boolean # –°–∞–º–æ—Ñ–∞–∫—Ç—É—Ä–∏—Ä–∞–Ω–µ
field :related_party, :boolean          # –°–≤—ä—Ä–∑–∞–Ω–æ –ª–∏—Ü–µ
field :related_party_start_date, :date
field :related_party_end_date, :date
```

#### –ë–∞–Ω–∫–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
```elixir
field :iban_number, :string
field :bank_account_number, :string
field :bank_sort_code, :string
```

#### –°—á–µ—Ç–æ–≤–æ–¥–Ω–∏ —Å–∞–ª–¥–∞:
```elixir
field :accounting_account_id, :integer   # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ —Å—á–µ—Ç–æ–≤–æ–¥–Ω–∞ —Å–º–µ—Ç–∫–∞ (—Ä–µ–∫–æ–Ω—Å–∏–ª–∏–∞—Ü–∏–æ–Ω–Ω–∞)
field :opening_debit_balance, :decimal
field :opening_credit_balance, :decimal
field :closing_debit_balance, :decimal
field :closing_credit_balance, :decimal
```

#### –î–∞–Ω—ä—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
```elixir
field :tax_authority, :string           # NRA
field :tax_verification_date, :date
```

#### –ò–º–µ–Ω–∞:
```elixir
field :name_latin, :string              # –ó–∞ —á—É–∂–¥–µ—Å—Ç—Ä–∞–Ω–Ω–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∏
field :name_cyrillic, :string           # –ö–∏—Ä–∏–ª—Å–∫–æ –∏–º–µ
```

### –ú–∏–≥—Ä–∞—Ü–∏—è:

**–§–∞–π–ª:** `20251011154008_add_saft_fields_to_contacts.exs`

–î–æ–±–∞–≤–µ–Ω–∏ –∏–Ω–¥–µ–∫—Å–∏:
- `registration_number`
- `vat_number`
- `is_supplier`
- `is_customer`

---

## SAF-T –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

**–ú–æ–¥—É–ª:** `CyberCore.Accounting.SaftExport`
**–§–∞–π–ª:** `apps/cyber_core/lib/cyber_core/accounting/saft_export.ex`

### –û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:

#### 1. –ú–µ—Å–µ—á–µ–Ω SAF-T —Ñ–∞–π–ª

```elixir
SaftExport.generate_monthly(tenant_id, year, month, output_path)

# –ü—Ä–∏–º–µ—Ä:
{:ok, path} = SaftExport.generate_monthly(1, 2025, 10, "/tmp/saft_monthly_2025_10.xml")
```

**–í–∫–ª—é—á–≤–∞:**
- Header
- Master Files (—Å—á–µ—Ç–æ–ø–ª–∞–Ω, –∫–ª–∏–µ–Ω—Ç–∏, –¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏)
- General Ledger Entries (—Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏ –∑–∞ –º–µ—Å–µ—Ü–∞)
- Source Documents (–¥–æ–∫—É–º–µ–Ω—Ç–∏ –∑–∞ –º–µ—Å–µ—Ü–∞)

#### 2. –ì–æ–¥–∏—à–µ–Ω SAF-T —Ñ–∞–π–ª

```elixir
SaftExport.generate_annual(tenant_id, year, output_path)

# –ü—Ä–∏–º–µ—Ä:
{:ok, path} = SaftExport.generate_annual(1, 2025, "/tmp/saft_annual_2025.xml")
```

**–í–∫–ª—é—á–≤–∞:**
- Header
- Master Files
- Source Documents (–≥–æ–¥–∏—à–Ω–∏ —Å—É–º–∏)

#### 3. SAF-T –ø—Ä–∏ –ø–æ–∏—Å–∫–≤–∞–Ω–µ (OnDemand)

```elixir
SaftExport.generate_on_demand(tenant_id, start_date, end_date, output_path)

# –ü—Ä–∏–º–µ—Ä:
{:ok, path} = SaftExport.generate_on_demand(
  1,
  ~D[2025-01-01],
  ~D[2025-12-31],
  "/tmp/saft_ondemand.xml"
)
```

**–í–∫–ª—é—á–≤–∞:**
- Header —Å –ø–µ—Ä–∏–æ–¥
- Master Files
- Source Documents –∑–∞ –ø–µ—Ä–∏–æ–¥–∞

### –í—ä—Ç—Ä–µ—à–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```elixir
defp build_monthly_xml(tenant_id, year, month, settings) do
  header = build_header(settings, year, month, "M")
  master_files = build_master_files_monthly(tenant_id, year, month)
  general_ledger = build_general_ledger_entries(tenant_id, year, month)
  source_documents = build_source_documents_monthly(tenant_id, year, month)

  # –ö–æ–º–±–∏–Ω–∏—Ä–∞ –≤—Å–∏—á–∫–∏ —á–∞—Å—Ç–∏ –≤ –ø—ä–ª–µ–Ω XML
end
```

### XML –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ:

#### Accounts (–°–º–µ—Ç–∫–æ–ø–ª–∞–Ω):

```xml
<nsSAFT:Account>
  <nsSAFT:AccountID>123</nsSAFT:AccountID>
  <nsSAFT:AccountDescription>–ö–∞—Å–∞ BGN</nsSAFT:AccountDescription>
  <nsSAFT:TaxpayerAccountID>5010</nsSAFT:TaxpayerAccountID>
  <nsSAFT:AccountType>Asset</nsSAFT:AccountType>
  <nsSAFT:AccountCreationDate>2025-01-01</nsSAFT:AccountCreationDate>
  <nsSAFT:OpeningDebitBalance>1000.00</nsSAFT:OpeningDebitBalance>
  <nsSAFT:ClosingDebitBalance>1500.00</nsSAFT:ClosingDebitBalance>
</nsSAFT:Account>
```

**Account Types:**
- `Asset` - –ê–∫—Ç–∏–≤–∏ (—Å–º–µ—Ç–∫–∏ 1, 2, 3)
- `Liability` - –ü–∞—Å–∏–≤–∏ (—Å–º–µ—Ç–∫–∏ 4, 5)
- `Expense` - –†–∞–∑—Ö–æ–¥–∏ (—Å–º–µ—Ç–∫–∏ 6)
- `Income` - –ü—Ä–∏—Ö–æ–¥–∏ (—Å–º–µ—Ç–∫–∏ 7)
- `Bifunctional` - –î–≤—É—Å—Ç—Ä–∞–Ω–Ω–∏ —Å–º–µ—Ç–∫–∏

#### Customers (–ö–ª–∏–µ–Ω—Ç–∏):

```xml
<nsSAFT:Customer>
  <nsSAFT:CompanyStructure>
    <nsSAFT:RegistrationNumber>123456789</nsSAFT:RegistrationNumber>
    <nsSAFT:Name>–ö–ª–∏–µ–Ω—Ç –û–û–î</nsSAFT:Name>
    <nsSAFT:Address>
      <nsSAFT:StreetName>—É–ª. –í–∏—Ç–æ—à–∞</nsSAFT:StreetName>
      <nsSAFT:Number>1</nsSAFT:Number>
      <nsSAFT:City>–°–æ—Ñ–∏—è</nsSAFT:City>
      <nsSAFT:PostalCode>1000</nsSAFT:PostalCode>
      <nsSAFT:Country>BG</nsSAFT:Country>
      <nsSAFT:AddressType>StreetAddress</nsSAFT:AddressType>
    </nsSAFT:Address>
    <nsSAFT:TaxRegistration>
      <nsSAFT:TaxNumber>BG123456789</nsSAFT:TaxNumber>
      <nsSAFT:TaxType>100010</nsSAFT:TaxType>
    </nsSAFT:TaxRegistration>
    <nsSAFT:RelatedParty>N</nsSAFT:RelatedParty>
  </nsSAFT:CompanyStructure>
  <nsSAFT:CustomerID>42</nsSAFT:CustomerID>
  <nsSAFT:SelfBillingIndicator>N</nsSAFT:SelfBillingIndicator>
  <nsSAFT:AccountID>411</nsSAFT:AccountID>
  <nsSAFT:OpeningDebitBalance>0.00</nsSAFT:OpeningDebitBalance>
  <nsSAFT:ClosingDebitBalance>2500.00</nsSAFT:ClosingDebitBalance>
</nsSAFT:Customer>
```

#### Suppliers (–î–æ—Å—Ç–∞–≤—á–∏—Ü–∏):

```xml
<nsSAFT:Supplier>
  <nsSAFT:CompanyStructure>
    <!-- –°—ä—â–∞—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–æ Customer -->
  </nsSAFT:CompanyStructure>
  <nsSAFT:SupplierID>15</nsSAFT:SupplierID>
  <nsSAFT:AccountID>401</nsSAFT:AccountID>
  <nsSAFT:OpeningCreditBalance>0.00</nsSAFT:OpeningCreditBalance>
  <nsSAFT:ClosingCreditBalance>3000.00</nsSAFT:ClosingCreditBalance>
</nsSAFT:Supplier>
```

---

## –¢–∏–ø–æ–≤–µ SAF-T —Ñ–∞–π–ª–æ–≤–µ

### 1. Monthly (–ú–µ—Å–µ—á–µ–Ω)

**–£–ø–æ—Ç—Ä–µ–±–∞:** –†–µ–¥–æ–≤–Ω–æ –ø–æ–¥–∞–≤–∞–Ω–µ –Ω–∞ –º–µ—Å–µ—á–Ω–∏ –¥–∞–Ω–Ω–∏ –∫—ä–º –ù–ê–ü

**–í–∫–ª—é—á–≤–∞:**
- –í—Å–∏—á–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –º–µ—Å–µ—Ü–∞
- –ì–ª–∞–≤–Ω–∞ –∫–Ω–∏–≥–∞ (–¥–Ω–µ–≤–Ω–∏–∫)
- –ü—ä—Ä–≤–∏—á–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (—Ñ–∞–∫—Ç—É—Ä–∏, –ø–ª–∞—â–∞–Ω–∏—è)

**–§–∞–π–ª–æ–≤–æ –∏–º–µ:** `saft_monthly_YYYY_MM.xml`

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```xml
<nsSAFT:AuditFile>
  <nsSAFT:Header>
    <nsSAFT:HeaderComment>M</nsSAFT:HeaderComment>
  </nsSAFT:Header>
  <nsSAFT:MasterFilesMonthly>
    ...
  </nsSAFT:MasterFilesMonthly>
  <nsSAFT:GeneralLedgerEntries>
    ...
  </nsSAFT:GeneralLedgerEntries>
  <nsSAFT:SourceDocumentsMonthly>
    ...
  </nsSAFT:SourceDocumentsMonthly>
</nsSAFT:AuditFile>
```

### 2. Annual (–ì–æ–¥–∏—à–µ–Ω)

**–£–ø–æ—Ç—Ä–µ–±–∞:** –ì–æ–¥–∏—à–Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç

**–í–∫–ª—é—á–≤–∞:**
- –û–±–æ–±—â–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –≥–æ–¥–∏–Ω–∞—Ç–∞
- –ì–æ–¥–∏—à–Ω–∏ —Å–∞–ª–¥–∞ –ø–æ —Å–º–µ—Ç–∫–∏
- –û–±–æ–±—â–µ–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏

**–§–∞–π–ª–æ–≤–æ –∏–º–µ:** `saft_annual_YYYY.xml`

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```xml
<nsSAFT:AuditFile>
  <nsSAFT:Header>
    <nsSAFT:HeaderComment>A</nsSAFT:HeaderComment>
  </nsSAFT:Header>
  <nsSAFT:MasterFilesAnnual>
    ...
  </nsSAFT:MasterFilesAnnual>
  <nsSAFT:SourceDocumentsAnnual>
    ...
  </nsSAFT:SourceDocumentsAnnual>
</nsSAFT:AuditFile>
```

### 3. OnDemand (–ü—Ä–∏ –ø–æ–∏—Å–∫–≤–∞–Ω–µ)

**–£–ø–æ—Ç—Ä–µ–±–∞:** –ü—Ä–∏ –¥–∞–Ω—ä—á–Ω–∞ —Ä–µ–≤–∏–∑–∏—è –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ –∏—Å–∫–∞–Ω–µ –æ—Ç –ù–ê–ü

**–í–∫–ª—é—á–≤–∞:**
- –î–∞–Ω–Ω–∏ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –ø–µ—Ä–∏–æ–¥
- –í—Å–∏—á–∫–∏ –¥–µ—Ç–∞–π–ª–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥–∞

**–§–∞–π–ª–æ–≤–æ –∏–º–µ:** `saft_ondemand_YYYY_MM_DD_to_YYYY_MM_DD.xml`

**–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```xml
<nsSAFT:AuditFile>
  <nsSAFT:Header>
    <nsSAFT:HeaderComment>OnDemand</nsSAFT:HeaderComment>
  </nsSAFT:Header>
  <nsSAFT:MasterFilesOnDemand>
    ...
  </nsSAFT:MasterFilesOnDemand>
  <nsSAFT:SourceDocumentsOnDemand>
    ...
  </nsSAFT:SourceDocumentsOnDemand>
</nsSAFT:AuditFile>
```

---

## –ü—Ä–∏–º–µ—Ä–∏ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞

### –ü—Ä–∏–º–µ—Ä 1: –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç —Å –≤—Å–∏—á–∫–∏ SAF-T –ø–æ–ª–µ—Ç–∞

```elixir
{:ok, contact} = Repo.insert(
  Contact.changeset(%Contact{}, %{
    tenant_id: 1,
    name: "–ö–ª–∏–µ–Ω—Ç –ï–û–û–î",
    name_cyrillic: "–ö–ª–∏–µ–Ω—Ç –ï–û–û–î",
    name_latin: "Client Ltd",

    # Identification
    registration_number: "123456789",
    vat_number: "BG123456789",
    tax_type: "100010",

    # Address
    street_name: "—É–ª. –í–∏—Ç–æ—à–∞",
    building_number: "100",
    city: "–°–æ—Ñ–∏—è",
    postal_code: "1000",
    region: "BG-22",
    country: "BG",

    # Contact
    email: "contact@client.com",
    phone: "0888123456",
    fax: "028123456",
    website: "https://client.com",

    contact_person_title: "–ì-–Ω",
    contact_person_first_name: "–ò–≤–∞–Ω",
    contact_person_last_name: "–ò–≤–∞–Ω–æ–≤",

    # Classification
    is_customer: true,
    is_supplier: false,
    is_company: true,
    self_billing_indicator: false,
    related_party: false,

    # Bank
    iban_number: "BG80BNBG96611020345678",

    # Accounting
    accounting_account_id: "411",
    opening_debit_balance: Decimal.new("0.00"),
    closing_debit_balance: Decimal.new("2500.00"),

    # Tax
    tax_authority: "NRA",
    tax_verification_date: ~D[2025-01-01]
  })
)
```

### –ü—Ä–∏–º–µ—Ä 2: –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –º–µ—Å–µ—á–µ–Ω SAF-T —Ñ–∞–π–ª

```elixir
# –ó–∞ –æ–∫—Ç–æ–º–≤—Ä–∏ 2025
{:ok, path} = SaftExport.generate_monthly(
  1,                            # tenant_id
  2025,                         # year
  10,                           # month
  "/tmp/saft_monthly_2025_10.xml"
)

IO.puts("SAF-T —Ñ–∞–π–ª—ä—Ç –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω: #{path}")
```

### –ü—Ä–∏–º–µ—Ä 3: –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –≥–æ–¥–∏—à–µ–Ω SAF-T —Ñ–∞–π–ª

```elixir
# –ó–∞ 2025 –≥–æ–¥–∏–Ω–∞
{:ok, path} = SaftExport.generate_annual(
  1,                            # tenant_id
  2025,                         # year
  "/tmp/saft_annual_2025.xml"
)

IO.puts("–ì–æ–¥–∏—à–µ–Ω SAF-T —Ñ–∞–π–ª: #{path}")
```

### –ü—Ä–∏–º–µ—Ä 4: –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–≤–∞–Ω–µ –æ—Ç –ù–ê–ü

```elixir
# –ó–∞ –ø–µ—Ä–∏–æ–¥ –æ—Ç 01.01.2025 –¥–æ 30.06.2025
{:ok, path} = SaftExport.generate_on_demand(
  1,
  ~D[2025-01-01],
  ~D[2025-06-30],
  "/tmp/saft_ondemand_q1_q2.xml"
)

IO.puts("OnDemand SAF-T —Ñ–∞–π–ª: #{path}")
```

### –ü—Ä–∏–º–µ—Ä 5: –¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∏ –ø–æ —Ç–∏–ø

```elixir
# –í—Å–∏—á–∫–∏ –¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏
suppliers = Repo.all(
  from c in Contact,
  where: c.tenant_id == ^1
    and c.is_supplier == true,
  order_by: [asc: c.name]
)

# –í—Å–∏—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∏ —Å –î–î–°
vat_customers = Repo.all(
  from c in Contact,
  where: c.tenant_id == ^1
    and c.is_customer == true
    and not is_nil(c.vat_number),
  order_by: [asc: c.name]
)

# –°–≤—ä—Ä–∑–∞–Ω–∏ –ª–∏—Ü–∞
related_parties = Repo.all(
  from c in Contact,
  where: c.tenant_id == ^1
    and c.related_party == true
)
```

---

## –†–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä–∏:

**–õ–æ–∫–∞—Ü–∏—è:** `/home/dvg/z-nim-proloq/cyber_ERP/FILE/SAFT_BG/`

**–§–∞–π–ª–æ–≤–µ:**
1. `BG_SAFT_Schema_V_1.0.1.xsd` - XSD —Å—Ö–µ–º–∞
2. `SAF-T_BG_Structure_Definition_V_1.0.1.xlsx` - Excel –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
3. `VS_SAMPLE_AuditFile_Monthly_V_1.0.1.xml` - –ü—Ä–∏–º–µ—Ä–µ–Ω –º–µ—Å–µ—á–µ–Ω —Ñ–∞–π–ª
4. `VS_SAMPLE_AuditFile_Annual_V_1.0.xml` - –ü—Ä–∏–º–µ—Ä–µ–Ω –≥–æ–¥–∏—à–µ–Ω —Ñ–∞–π–ª
5. `VS_SAMPLE_AuditFile_OnDemand_V_1.0.xml` - –ü—Ä–∏–º–µ—Ä–µ–Ω OnDemand —Ñ–∞–π–ª

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ:

```
apps/cyber_core/
‚îú‚îÄ‚îÄ lib/cyber_core/
‚îÇ   ‚îú‚îÄ‚îÄ accounting/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ saft_export.ex           # SAF-T –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ contacts/
‚îÇ       ‚îî‚îÄ‚îÄ contact.ex                # –†–∞–∑—à–∏—Ä–µ–Ω–∞ Contact —Å—Ö–µ–º–∞
‚îú‚îÄ‚îÄ priv/repo/migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 20251011154008_add_saft_fields_to_contacts.exs
‚îî‚îÄ‚îÄ test/cyber_core/accounting/
    ‚îî‚îÄ‚îÄ saft_export_test.exs         # TODO: –¢–µ—Å—Ç–æ–≤–µ

docs/
‚îú‚îÄ‚îÄ SAFT-docs.md                      # –¢–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç
‚îî‚îÄ‚îÄ VAT-docs.md                       # –î–î–° –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### –í—Ä—ä–∑–∫–∞ —Å –î–î–° —Å–∏—Å—Ç–µ–º–∞:

SAF-T —Ñ–∞–π–ª–æ–≤–µ—Ç–µ –≤–∫–ª—é—á–≤–∞—Ç –î–î–° –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç:
- `vat_sales_register` - –î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏
- `vat_purchase_register` - –î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
- `vat_returns` - –î–î–° —Å–ø—Ä–∞–≤–∫–∏

–í–∏–∂—Ç–µ **VAT-docs.md** –∑–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∑–∞ –î–î–° –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è—Ç–∞.

---

## –í–∞–∂–Ω–∏ –±–µ–ª–µ–∂–∫–∏

### ‚ö†Ô∏è TODOItems:

1. **General Ledger Entries** - –¢—Ä—è–±–≤–∞ –¥–∞ —Å–µ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏
2. **Source Documents** - –¢—Ä—è–±–≤–∞ –¥–∞ —Å–µ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏—á–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏:
   - Sales Invoices
   - Purchase Invoices
   - Payments
   - Stock Movements
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø—Ä—è–º–æ XSD —Å—Ö–µ–º–∞
4. **–¢–µ—Å—Ç–æ–≤–µ** - Unit tests –∑–∞ SAF-T –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
5. **UI** - LiveView –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –∏ –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ SAF-T —Ñ–∞–π–ª–æ–≤–µ

### üìã –ò–∑–∏—Å–∫–≤–∞–Ω–∏—è –Ω–∞ –ù–ê–ü:

- –§–∞–π–ª—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –≤–∞–ª–∏–¥–µ–Ω —Å–ø—Ä—è–º–æ XSD —Å—Ö–µ–º–∞—Ç–∞
- –ö–æ–¥–∏—Ä–æ–≤–∫–∞ UTF-8
- –í—Å–∏—á–∫–∏ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ –ø–æ–ø—ä–ª–Ω–µ–Ω–∏
- –î–∞—Ç–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç ISO 8601 (YYYY-MM-DD)
- –ß–∏—Å–ª–æ–≤–∏—Ç–µ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏ —Å —Ç–æ—á–∫–∞ –∫–∞—Ç–æ –¥–µ—Å–µ—Ç–∏—á–µ–Ω —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª
- XML escape –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ —Å–∏–º–≤–æ–ª–∏

### üîí –°–∏–≥—É—Ä–Ω–æ—Å—Ç:

- SAF-T —Ñ–∞–π–ª–æ–≤–µ—Ç–µ —Å—ä–¥—ä—Ä–∂–∞—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ –µ –¥–∞ —Å–µ —à–∏—Ñ—Ä–æ–≤–∞—Ç –ø—Ä–µ–¥–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ
- –î–æ—Å—Ç—ä–ø—ä—Ç –¥–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Å–∞–º–æ –∑–∞ –æ–≤–ª–∞—Å—Ç–µ–Ω–∏ –ª–∏—Ü–∞
- –õ–æ–≥–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

SAF-T –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è—Ç–∞ –≤ Cyber ERP –æ—Å–∏–≥—É—Ä—è–≤–∞:

‚úÖ –ü—ä–ª–Ω–∞ —Å—ä–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç —Å –±—ä–ª–≥–∞—Ä—Å–∫–∞—Ç–∞ SAF-T —Å—Ö–µ–º–∞ –≤–µ—Ä—Å–∏—è 1.0.1
‚úÖ –¢—Ä–∏ —Ç–∏–ø–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ (–º–µ—Å–µ—á–µ–Ω, –≥–æ–¥–∏—à–µ–Ω, –ø—Ä–∏ –ø–æ–∏—Å–∫–≤–∞–Ω–µ)
‚úÖ –†–∞–∑—à–∏—Ä–µ–Ω–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—Å–∫–∏ –¥–∞–Ω–Ω–∏
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –î–î–° —Å–∏—Å—Ç–µ–º–∞
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ XML —Ñ–∞–π–ª–æ–≤–µ

**–°–ª–µ–¥–≤–∞—â–∏ —Å—Ç—ä–ø–∫–∏:**
1. –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–µ –Ω–∞ General Ledger Entries
2. –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–µ –Ω–∞ Source Documents
3. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ XSD –≤–∞–ª–∏–¥–∞—Ü–∏—è
4. –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ UI –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ
5. –¢–µ—Å—Ç–≤–∞–Ω–µ —Å —Ä–µ–∞–ª–Ω–∏ –¥–∞–Ω–Ω–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç—ä—Ç –µ –∞–∫—Ç—É–∞–ª–µ–Ω –∫—ä–º:** 2025-10-11

**–ê–≤—Ç–æ—Ä:** Claude (AI –∞—Å–∏—Å—Ç–µ–Ω—Ç)

**–í–µ—Ä—Å–∏—è:** 1.0
