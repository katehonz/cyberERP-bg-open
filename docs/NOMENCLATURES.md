# Номенклатури за SAF-T и Intrastat

Този документ описва как са имплементирани номенклатурите за SAF-T и Intrastat в системата.

## Структура

```
apps/cyber_core/lib/cyber_core/inventory/
├── product.ex                  # Основна схема за продукти
├── cn_nomenclature.ex         # Комбинирана номенклатура КН8
├── measurement_unit.ex        # Мерни единици (SAF-T)
├── product_unit.ex            # Мулти мерни единици за продукт
├── cn_importer.ex            # Импортер на КН номенклатура
└── README.md                  # Пълна документация

apps/cyber_core/priv/repo/
├── migrations/
│   ├── 20251119181937_create_cn_nomenclatures.exs
│   ├── 20251119181951_create_measurement_units.exs
│   ├── 20251119181952_create_product_units.exs
│   └── 20251119181953_add_cn_code_to_products.exs
└── seeds/
    ├── measurement_units.exs          # Seed за стандартни мерни единици
    └── cn_nomenclature_2025.exs      # Импорт на КН 2025
```

## Бърз старт

### 1. Стартиране на миграциите

```bash
mix ecto.migrate
```

### 2. Зареждане на стандартни мерни единици

```bash
mix run apps/cyber_core/priv/repo/seeds/measurement_units.exs
```

Това ще създаде следните стандартни мерни единици за всички тенанти:
- Маса: kg, g, t
- Обем: l, ml, hl
- Дължина: m, cm, mm, km
- Площ: m², cm², ha
- Обем: m³, cm³
- Брой: бр., двойка, комплект, дузина
- Опаковки: пакет, кутия, палет, торба, бутилка
- Енергия: kWh, MWh
- Време: час, ден, месец

### 3. Импорт на Комбинирана номенклатура КН8-2025

```bash
mix run apps/cyber_core/priv/repo/seeds/cn_nomenclature_2025.exs
```

Това ще импортира ~15,000 записа от файла `FILE/INTRASTAT/CN_2025_NAP (1.csv`

## Използване

### Създаване на продукт с мулти мерни единици

```elixir
# В IEx консола
iex -S mix

# Зареждане на необходимите модули
alias CyberCore.Repo
alias CyberCore.Inventory.{Product, MeasurementUnit, ProductUnit, CnNomenclature}
alias CyberCore.Accounts.Tenant

# Взимане на тенант
tenant = Repo.get_by(Tenant, slug: "demo")

# Търсене на КН код за коне
cn_code = Repo.get_by(CnNomenclature, code: "01012100", year: 2025)

# Създаване на продукт
{:ok, product} = %Product{}
|> Product.changeset(%{
  tenant_id: tenant.id,
  name: "Кон расов за разплод",
  sku: "HORSE-001",
  category: "goods",
  cn_code_id: cn_code.id,
  price: Decimal.new("5000"),
  cost: Decimal.new("3000")
})
|> Repo.insert()

# Добавяне на основна мерна единица (брой)
unit_piece = Repo.get_by(MeasurementUnit, tenant_id: tenant.id, code: "p/st")

{:ok, _} = %ProductUnit{}
|> ProductUnit.changeset(%{
  product_id: product.id,
  measurement_unit_id: unit_piece.id,
  conversion_factor: Decimal.new(1),
  is_primary: true
})
|> Repo.insert()

# Добавяне на допълнителна мерна единица (kg за теглова проверка)
unit_kg = Repo.get_by(MeasurementUnit, tenant_id: tenant.id, code: "kg")

{:ok, _} = %ProductUnit{}
|> ProductUnit.changeset(%{
  product_id: product.id,
  measurement_unit_id: unit_kg.id,
  conversion_factor: Decimal.new(450),  # среден кон ~450kg
  is_primary: false
})
|> Repo.insert()
```

### Конвертиране между мерни единици

```elixir
# Имаме 5 кутии мляко по 12 литра, колко литра са общо?
from_unit = %ProductUnit{conversion_factor: Decimal.new(12)}  # кутия = 12л
to_unit = %ProductUnit{conversion_factor: Decimal.new(1)}     # литър = 1л

quantity = Decimal.new(5)  # 5 кутии

result = ProductUnit.convert(from_unit, to_unit, quantity)
IO.inspect(result)  # => 60 литра
```

### Търсене по КН код

```elixir
import Ecto.Query

# Всички продукти с КН код за коне
query = from p in Product,
  join: cn in CnNomenclature, on: p.cn_code_id == cn.id,
  where: cn.code == "01012100" and cn.year == 2025,
  preload: [:cn_code, :product_units]

products = Repo.all(query)
```

## SAF-T експорт

За SAF-T експорт продуктите съдържат следната информация:

- **ProductCode** - Product.sku
- **ProductDescription** - Product.name
- **ProductNumberCode** - CnNomenclature.code (КН8 код)
- **UOMBase** - MeasurementUnit.code (основна мерна единица)
- **UOMStandard** - MeasurementUnit.code (стандартна единица)

## Intrastat декларация

Системата автоматично генерира Intrastat декларации на базата на движенията на стоки в склада (`StockMovement`), които са свързани с документи за продажба (`Sales.Invoice`) или покупка (`Purchase.SupplierInvoice`).

Процесът е следният:

1.  **Създаване на документ за продажба/покупка:** При създаване на документ, който генерира складово движение (напр. фактура), се създава запис в `StockMovement`.
2.  **Продукт с КН код:** Всеки `Product` трябва да има асоцииран `cn_code` (Комбинирана номенклатура).
3.  **Връзка между движение и документ:** Всеки запис в `StockMovement` има `reference_id` и `reference_type`, които го свързват с оригиналния документ (напр. `Sales.Invoice`).
4.  **Генериране на Intrastat декларация:** `Intrastat` модулът използва записите за складови движения (`StockMovement`), за да намери оригиналния продукт и свързания с него документ. От продукта се взима `cn_code`, а от документа - държавата на партньора.

Този подход гарантира, че Intrastat декларацията се базира на реалното движение на стоки, което е и правилното изискване. Настройките за Интрастат вече не са част от сметкоплана, а са пряко свързани с продуктите и складовите движения.

Менюто за Intrastat в потребителския интерфейс се намира в секция **Складово стопанство**.

## Бъдещи подобрения

- [ ] UI за управление на мерни единици
- [ ] UI за търсене и избор на КН кодове
- [ ] Автоматично предложение на КН код по описание (AI)
- [ ] Валидация на баркодове (EAN-13, EAN-8, UPC)
- [ ] История на промени в цени и себестойности
- [ ] Batch импорт/експорт на продукти
- [ ] Генериране на SAF-T XML файл
- [x] Интеграция с Intrastat модул
- [ ] Отчети за движение на стоки по КН кодове
- [ ] Multi-язична поддръжка на описанията

## Референции

- [SAF-T BG Format Specification](../../../FILE/SAFT_BG/)
- [Intrastat CN Nomenclature](../../../FILE/INTRASTAT/)
- [НАП SAF-T изисквания](https://nap.bg/)

## Списък на номенклатурите, използвани в SAF-T

| Номер | Име на номенклатура | Име на таблица | Описание на номенклатурата |
| :--- | :--- | :--- | :--- |
| 1 | Номенклатура на данъци, осигуровки и такси по Закона за хазарта в България | TAX-IMP | Номенклатура с кодове за данъци.<br>Номенклатурата съдържа кодовете за попълване на полето TaxType и TaxCode. Това е цифров код, състоящ се от десетични цифри.<br>При подаване на SAF-T следва да бъдат използвани съответните кодове на данъците.<br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 2 | Номенклатура на IBAN банкови сметки формати | IBAN-ISO13616-1997 | Форматът на IBAN кодовете за всяка държава, която използва този стандарт. <br>Форматът се използва за попълване на полетата в схемата, които се отнасят до IBAN и за валидиране на тези номера на сметки. <br>Проверката на синтаксиса включва:<br> - проверка на съответствието между държавата на пребиваване и полето за държава за IBAN сметката<br> - проверка на коректността на IBAN сметката чрез контролната сума. |
| 3 | Номенклатура на области | ISO 3166-2BG Area Codes | Номенклатура на кодове за териториални единици в България. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 4 | Номенклатурни държави | ISO3166-1-CountryCodes | Номенклатура на кодове на държавите. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 5 | Номенклатура на валути | ISO4217CurrCodes | Номенклатура на кодове на валута.<br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 6 | Номенклатура за видовете издадени и получиени фактури/документи. | Nom_Invoice_Types | Номенклатура за видовете издадени и получени фактури/документи. <br>Кодове се използват за попълване на поле InvoiceType от 5.10 InvoiceStructure. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 7 | Номенклатура на механизмите за плащане | Nom_PaymentMethod | Номенклатура за използваните инструменти и механизми за плащане. Кодовете се използват за попълване на полето PaymentMethod от Payment и PaymentMechanism от InvoiceSettlement . <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 8 | Номенклатура на счетоводните сметки | NRA_Nom_Accounts | Номенклатура на счетоводните сметки. <br>Използването на тези сметки при подаването на SAF-T е задължително. |
| 9 | Номенклатура на мерните единици | Unit_Of_Measure | Номенклатура на стандартизираните мерни единици, произтичащи от комбинираната номенклатура, която съдържа списък на съкращенията на мерните единици и техните кодове. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 10 | Комбинирана номенклатура КН8 - 2025 | NC8_TARIC | Кодове, използвани за попълване на полето PrоductCommodityCode за продукти в подаваните документи - фактури за продажба, фактури за покупка и т.н. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 11 | Номенклатура за движение на продукти (материални запаси) | Stock_movements | Номенклатура за кодове на движение на продукти (материални запаси). Кодовете се използват за попълване на полето MovementType и StockMovementType. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 12 | Номенклатура за движение на активи | AssetMovementTypes | Номенклатура на видове движения на активи. <br>Кодовете се използват за попълване на полето AssetTransactionType. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 13 | Номенклатура на данъчните режими | VAT_TaxType | Номенклатура за определяне на данъчния режими от гледна точка на ДДС. <br>Кодовете се използват за попълване на полето TaxType от TaxIDStructre. <br>Използването на тези кодове при подаването на SAF-T е задължително. |
| 14 | Номенклатура за вид на материалния запас. | Nom_Inventory_Types | Номенклатура за вид на материалния запас. <br>Кодове, използвани за попълване на полето ProductType. <br>Използването на тези кодове при подаването на SAF-T е задължително. |

### Номенклатура за движение на активи (AssetMovementTypes)

| Код | Описание |
| :-- | :--- |
| 10 | Придобиване |
| 20 | Продажба |
| 30 | Амортизация |
| 40 | Вътрешен трансфер |
| 50 | Брак |
| 60 | Преоценка (отрицателна) |
| 70 | Преоценка (положителна) |
| 80 | Излишък (при инвентаризация) |
| 90 | Липса (при инвентаризация) |
| 100 | Обезценка |
| 110 | Сторно на обезценка |
| 120 | Безвъзмездно предоставени активи |
| 130 | Други транзакции |