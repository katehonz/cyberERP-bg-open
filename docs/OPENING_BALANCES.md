# Начални салда (Opening Balances)

## Въведение

Функционалността за начални салда позволява на потребителите да въведат първоначалните стойности за складови наличности и счетоводни сметки при стартиране на нова компания или при миграция от друга система. Това е критична функционалност за осигуряване на точност на отчетите от самото начало на използване на системата.

## Структура

Функционалността включва:

1. Моделни промени - добавени полета за начални салда
2. Бизнес логика - функции за управление на начални салда
3. Потребителски интерфейс - LiveView компонент за управление
4. Интеграция - автоматично създаване на нужните записи

## Моделни промени

### Product (Продукт)

Добавени са следните полета:
- `opening_quantity` - начално количество (decimal)
- `opening_cost` - начална единична цена (decimal)

### Account (Счетоводна сметка)

Добавено е следното поле:
- `opening_balance` - начално салдо (decimal)

## Бизнес логика

### Inventory контекст

#### set_opening_balance/5

```elixir
set_opening_balance(tenant_id, product_id, warehouse_id, quantity, cost)
```

Функцията задава начално салдо за продукт в склад:

1. Актуализира продукта със зададеното количество и цена
2. Създава запис в таблицата за складови наличности (StockLevel)
3. Генерира счетоводен запис (journal entry) с дебит към сметка 302 (Материали) и кредит към сметка 801 (Уставен капитал)

**Изисквания:** Трябва да съществуват сметки с кодове `302` и `801` в системата.

#### remove_opening_balance/2

```elixir
remove_opening_balance(tenant_id, product_id)
```

Функцията премахва зададеното начално салдо за продукт.

#### list_products_with_opening_balances/1

```elixir
list_products_with_opening_balances(tenant_id)
```

Функцията връща списък с всички продукти, които имат зададени начални салда.

### Accounting контекст

#### set_account_opening_balance/3

```elixir
set_account_opening_balance(tenant_id, account_id, balance)
```

Функцията задава начално салдо за счетоводна сметка:

1. Актуализира сметката със зададеното начално салдо
2. Генерира счетоводен запис (journal entry) срещу сметка 801 (Уставен капитал)

**Изисквания:** Трябва да съществува сметка с код `801` в системата.

#### remove_account_opening_balance/2

```elixir
remove_account_opening_balance(tenant_id, account_id)
```

Функцията премахва зададеното начално салдо за сметка.

#### list_accountsWithOpeningBalances/1

```elixir
list_accountsWithOpeningBalances(tenant_id)
```

Функцията връща списък с всички сметки, които имат зададени начални салда.

## Потребителски интерфейс

### OpeningBalances LiveView

Новият компонент предоставя интерфейс за управление на началните салда:

- Таб за складови наличности
- Таб за счетоводни сметки
- Форми за въвеждане на начални салда
- Списък с вече зададени начални салда
- Възможност за премахване на зададени начални салда

Маршрути:
- `/inventory/opening-balances`
- `/accounting/opening-balances`

## Интеграция с други модули

### SAF-T

Функционалността влияе на генерирането на SAF-T файлове, като използва зададените начални салда при изчислението на началните баланси в главната книга.

### Reporting

Отчетите за главна книга и оборотна ведомост използват зададените начални салда при изчисленията си.

## Примери за използване

### Задаване на начално салдо за склад

1. Потребителят влиза в "Склад" -> "Начални салда"
2. Избира продукт, склад, количество и цена
3. Системата създава запис в складовите наличности
4. Системата генерира счетоводен запис

### Задаване на начално салдо за сметка

1. Потребителят влиза в "Счетоводство" -> "Начални салда"
2. Избира сметка и салдо
3. Системата актуализира сметката
4. Системата генерира счетоводен запис

## Тестване

### Inventory

- Проверка дали се записват правилно началните салда
- Проверка дали се създават складови движения
- Проверка дали се генерират счетоводни записи

### Accounting

- Проверка дали се записват правилно началните салда за сметки
- Проверка дали се генерират счетоводни записи

## Бъдещи подобрения

1. Масов импорт на начални салда чрез CSV файл
2. Валидация за двойна запис на начални салда
3. История на промените на началните салда
4. Възможност за редактиране на вече зададени начални салда