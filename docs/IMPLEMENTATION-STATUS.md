# –°—Ç–∞—Ç—É—Å –Ω–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è—Ç–∞ - Cyber ERP

**–î–∞—Ç–∞:** 2025-10-21
**–í–µ—Ä—Å–∏—è:** 1.1

---

## ‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∏ –º–æ–¥—É–ª–∏

### 1. –î–î–° (VAT) —Å–∏—Å—Ç–µ–º–∞ - **100% –∑–∞–≤—ä—Ä—à–µ–Ω–∞**

**–§–∞–π–ª–æ–≤–µ:**
- `lib/cyber_core/accounting/vat.ex` - –ö–æ–Ω—Ç–µ–∫—Å—Ç
- `lib/cyber_core/accounting/vat_return.ex` - –î–î–° —Å–ø—Ä–∞–≤–∫–∞
- `lib/cyber_core/accounting/vat_sales_register.ex` - –î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏
- `lib/cyber_core/accounting/vat_purchase_register.ex` - –î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
- `lib/cyber_core/accounting/vat_operation_code.ex` - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ
- `lib/cyber_core/accounting/nap_export.ex` - NAP —Ñ–∞–π–ª–æ–≤–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–æ–¥–µ–Ω–µ –Ω–∞ –¥–Ω–µ–≤–Ω–∏—Ü–∏ –∑–∞ –ø—Ä–æ–¥–∞–∂–±–∏ –∏ –ø–æ–∫—É–ø–∫–∏
- ‚úÖ –í—Å–∏—á–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ –ø–æ –ó–î–î–° (2-11, 2-17, 1-10-1, –∏ —Ç.–Ω.)
- ‚úÖ VIES –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ (–∫3, –∫4, –∫5)
- ‚úÖ –û–±—Ä–∞—Ç–Ω–æ –Ω–∞—á–∏—Å–ª—è–≤–∞–Ω–µ (reverse charge) —Å –ø–æ–¥–∫–æ–¥–æ–≤–µ (01, 02)
- ‚úÖ –î–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (full, partial, none, not_applicable)
- ‚úÖ –¢—Ä–∏—ä–≥—ä–ª–Ω–∏ —Å–¥–µ–ª–∫–∏
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ NAP —Ñ–∞–π–ª–æ–≤–µ (DEKLAR.TXT, POKUPKI.TXT, PRODAGBI.TXT)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- üìÑ `docs/VAT-docs.md` - –ü—ä–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (900+ —Ä–µ–¥–∞)

---

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞ - **100% –∑–∞–≤—ä—Ä—à–µ–Ω–∞**

**–§–∞–π–ª–æ–≤–µ:**
- `lib/cyber_core/settings.ex` - –ö–æ–Ω—Ç–µ–∫—Å—Ç
- `lib/cyber_core/settings/company_settings.ex` - Schema
- `lib/cyber_web/live/settings_live/index.ex` - LiveView

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç:**
- ‚úÖ –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∏–º–µ, –î–î–° –Ω–æ–º–µ—Ä, –ï–ò–ö)
- ‚úÖ –ê–¥—Ä–µ—Å, –≥—Ä–∞–¥, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª
- ‚úÖ –ë–∞–Ω–∫–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (IBAN, BIC, –±–∞–Ω–∫–∞)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –î–î–° –Ω–æ–º–µ—Ä (BGxxxxxxxxx —Ñ–æ—Ä–º–∞—Ç)
- ‚úÖ LiveView —Ñ–æ—Ä–º–∞ –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è –Ω–∞ `/settings`

---

### 3. Multi-Tenant —Å–∏—Å—Ç–µ–º–∞ - **100% –∑–∞–≤—ä—Ä—à–µ–Ω–∞**

**–§–∞–π–ª–æ–≤–µ:**
- `lib/cyber_core/accounts/tenant.ex` - Tenant schema
- `lib/cyber_core/accounts/user.ex` - User schema —Å many-to-many —Ä–µ–ª–∞—Ü–∏–∏
- `lib/cyber_core/accounts/user_tenant.ex` - Join table schema
- `lib/cyber_core/accounts.ex` - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- `lib/cyber_web/live/hooks/tenant_hook.ex` - LiveView hook
- `lib/cyber_web/live/tenant_live/index.ex` - UI –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ñ–∏—Ä–º–∏
- `lib/cyber_web/components/layouts/app.html.heex` - –ì–ª–æ–±–∞–ª–µ–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç:**
- ‚úÖ Many-to-many —Ä–µ–ª–∞—Ü–∏—è User ‚Üî Tenant
- ‚úÖ –†–æ–ª–∏ –∑–∞ –¥–æ—Å—Ç—ä–ø (admin, manager, user)
- ‚úÖ –ì–ª–æ–±–∞–ª–µ–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä –∑–∞ –ø—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Ñ–∏—Ä–º–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ tenants –≤—ä–≤ –≤—Å–∏—á–∫–∏ LiveView
- ‚úÖ UI –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ñ–∏—Ä–º–∏ (—Å–ø–∏—Å—ä–∫, –¥–æ–±–∞–≤—è–Ω–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ, –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ)
- ‚úÖ –í–∞–ª—É—Ç–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ per tenant
- ‚úÖ –ï–≤—Ä–æ–∑–æ–Ω–∞ –ø–æ–¥–¥—Ä—ä–∂–∫–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ EUR –∫–æ–Ω–≤–µ—Ä—Å–∏—è
- ‚úÖ –ü—ä–ª–Ω–∞ –∏–∑–æ–ª–∞—Ü–∏—è –Ω–∞ –¥–∞–Ω–Ω–∏ —Å tenant_id –≤—ä–≤ –≤—Å–∏—á–∫–∏ —Ç–∞–±–ª–∏—Ü–∏
- ‚úÖ Settings –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–∏–Ω–∫ –∫—ä–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ñ–∏—Ä–º–∏

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- üìÑ `docs/MULTI-TENANT.md` - –ü—ä–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (600+ —Ä–µ–¥–∞)

---

### 4. SAF-T —Å–∏—Å—Ç–µ–º–∞ - **80% –∑–∞–≤—ä—Ä—à–µ–Ω–∞**

**–§–∞–π–ª–æ–≤–µ:**
- `lib/cyber_core/contacts/contact.ex` - –†–∞–∑—à–∏—Ä–µ–Ω–∞ —Å—Ö–µ–º–∞
- `lib/cyber_core/accounting/saft_export.ex` - SAF-T –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

**–ó–∞–≤—ä—Ä—à–µ–Ω–∏ —á–∞—Å—Ç–∏:**
- ‚úÖ –†–∞–∑—à–∏—Ä–µ–Ω–∏ –ø–æ–ª–µ—Ç–∞ –≤ contacts (28 –Ω–æ–≤–∏ –ø–æ–ª–µ—Ç–∞)
- ‚úÖ Header —Å–µ–∫—Ü–∏—è (–ø—ä–ª–Ω–∞)
- ‚úÖ MasterFiles —Å–µ–∫—Ü–∏—è:
  - ‚úÖ GeneralLedgerAccounts (—Å–º–µ—Ç–∫–æ–ø–ª–∞–Ω)
  - ‚úÖ Customers (–∫–ª–∏–µ–Ω—Ç–∏)
  - ‚úÖ Suppliers (–¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏)
- ‚úÖ XML –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ —Å escape
- ‚úÖ 3 —Ç–∏–ø–∞ —Ñ–∞–π–ª–æ–≤–µ (Monthly, Annual, OnDemand)

**–ù–µ–∑–∞–≤—ä—Ä—à–µ–Ω–∏ —á–∞—Å—Ç–∏:**
- ‚è≥ GeneralLedgerEntries (—Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏)
- ‚è≥ SourceDocuments (–ø—ä—Ä–≤–∏—á–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏)
  - ‚è≥ SalesInvoices
  - ‚è≥ PurchaseInvoices
  - ‚è≥ Payments

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- üìÑ `docs/SAFT-docs.md` - –ü—ä–ª–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (1000+ —Ä–µ–¥–∞)

---

## üöß –¢–µ–∫—É—â–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –º–æ–¥—É–ª–∏—Ç–µ

### –°—á–µ—Ç–æ–≤–æ–¥—Å—Ç–≤–æ (Accounting)

**–°—Ö–µ–º–∏:**
```elixir
‚úÖ Account - –°–º–µ—Ç–∫–æ–ø–ª–∞–Ω
‚úÖ JournalEntry - –°—á–µ—Ç–æ–≤–æ–¥–µ–Ω –∑–∞–ø–∏—Å
‚è≥ JournalEntryLine - –î–µ—Ç–∞–π–ª –Ω–∞ –∑–∞–ø–∏—Å (–Ω—É–∂–µ–Ω –∑–∞ SAF-T)
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è:**
1. JournalEntryLine —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–∫–ª—é—á–≤–∞:
   - `account_id` - –°—á–µ—Ç–æ–≤–æ–¥–Ω–∞ —Å–º–µ—Ç–∫–∞
   - `debit_amount` / `credit_amount`
   - `currency_code`, `exchange_rate`
   - `tax_type`, `tax_code`, `tax_percentage`
   - `customer_id` / `supplier_id`
   - `description`

2. JournalEntry —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–∫–ª—é—á–≤–∞:
   - `journal_id` - –í–∏–¥ –¥–Ω–µ–≤–Ω–∏–∫ (GL, Sales, Purchase)
   - `transaction_type` - Normal, Opening, Closing
   - `source_document_id` - –í—Ä—ä–∑–∫–∞ –∫—ä–º –¥–æ–∫—É–º–µ–Ω—Ç

---

### –§–∞–∫—Ç—É—Ä–∏ (Invoices)

**–¢–µ–∫—É—â–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ:**
```elixir
‚úÖ Invoice - –û—Å–Ω–æ–≤–Ω–∞ —Å—Ö–µ–º–∞
‚úÖ InvoiceItem - –†–µ–¥–æ–≤–µ
‚úÖ –í—Ä—ä–∑–∫–∞ —Å VAT —Ä–µ–≥–∏—Å—Ç—Ä–∏
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º–∏ –ø–æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞ SAF-T:**
1. –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞:
   - `payment_mechanism` - –ù–∞—á–∏–Ω –Ω–∞ –ø–ª–∞—â–∞–Ω–µ
   - `payment_terms` - –£—Å–ª–æ–≤–∏—è –∑–∞ –ø–ª–∞—â–∞–Ω–µ
   - `settlement_amount` - –ü–ª–∞—Ç–µ–Ω–∞ —Å—É–º–∞
2. –ü—ä–ª–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—ä—Å —Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏

---

## üìã –ü–ª–∞–Ω –∑–∞ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: GeneralLedgerEntries (–≤–∏—Å–æ–∫)

**–ó–∞–¥–∞—á–∞:** –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ –∑–∞–ø–∏—Å–∏ –≤ SAF-T

**–°—Ç—ä–ø–∫–∏:**
1. –†–∞–∑—à–∏—Ä—è–≤–∞–Ω–µ –Ω–∞ `journal_entry_lines` —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å:
   ```elixir
   add :taxpayer_account_id, :string  # –ö–æ–¥ –Ω–∞ —Å–º–µ—Ç–∫–∞
   add :currency_code, :string
   add :currency_amount, :decimal
   add :exchange_rate, :decimal
   add :tax_type, :string
   add :tax_code, :string
   add :tax_percentage, :decimal
   add :tax_base, :decimal
   add :tax_amount, :decimal
   ```

2. –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–µ –Ω–∞ `build_general_ledger_entries/3` –≤ saft_export.ex:
   ```elixir
   defp build_general_ledger_entries(tenant_id, year, month) do
     entries = fetch_journal_entries(tenant_id, year, month)

     total_debit = calculate_total_debit(entries)
     total_credit = calculate_total_credit(entries)

     """
     <nsSAFT:GeneralLedgerEntries>
       <nsSAFT:NumberOfEntries>#{length(entries)}</nsSAFT:NumberOfEntries>
       <nsSAFT:TotalDebit>#{format_decimal(total_debit)}</nsSAFT:TotalDebit>
       <nsSAFT:TotalCredit>#{format_decimal(total_credit)}</nsSAFT:TotalCredit>
       <nsSAFT:Journal>
         <nsSAFT:JournalID>GL</nsSAFT:JournalID>
         <nsSAFT:Description>–ì–ª–∞–≤–Ω–∞ –∫–Ω–∏–≥–∞</nsSAFT:Description>
         <nsSAFT:Type>GLEntry</nsSAFT:Type>
         #{Enum.map_join(entries, "\n", &build_transaction_xml/1)}
       </nsSAFT:Journal>
     </nsSAFT:GeneralLedgerEntries>
     """
   end
   ```

3. –ü—Ä–∏–º–µ—Ä–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
   ```xml
   <nsSAFT:Transaction>
     <nsSAFT:TransactionID>#{entry.id}</nsSAFT:TransactionID>
     <nsSAFT:Period>#{entry.period_month}</nsSAFT:Period>
     <nsSAFT:PeriodYear>#{entry.period_year}</nsSAFT:PeriodYear>
     <nsSAFT:TransactionDate>#{entry.entry_date}</nsSAFT:TransactionDate>
     <nsSAFT:TransactionType>Normal</nsSAFT:TransactionType>
     <nsSAFT:Description>#{entry.description}</nsSAFT:Description>
     #{Enum.map_join(entry.lines, "\n", &build_transaction_line_xml/1)}
   </nsSAFT:Transaction>
   ```

**–í—Ä–µ–º–µ:** ~4-6 —á–∞—Å–∞

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: SourceDocuments (—Å—Ä–µ–¥–µ–Ω)

**–ó–∞–¥–∞—á–∞:** –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—ä—Ä–≤–∏—á–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –≤ SAF-T

**–°—Ç—ä–ø–∫–∏:**
1. SalesInvoices —Å–µ–∫—Ü–∏—è:
   ```elixir
   defp build_sales_invoices(tenant_id, year, month) do
     invoices = fetch_invoices(tenant_id, year, month, "sale")

     """
     <nsSAFT:SalesInvoices>
       <nsSAFT:NumberOfEntries>#{length(invoices)}</nsSAFT:NumberOfEntries>
       <nsSAFT:TotalDebit>#{calculate_total(invoices)}</nsSAFT:TotalDebit>
       <nsSAFT:TotalCredit>0.00</nsSAFT:TotalCredit>
       #{Enum.map_join(invoices, "\n", &build_sales_invoice_xml/1)}
     </nsSAFT:SalesInvoices>
     """
   end
   ```

2. –ü—Ä–∏–º–µ—Ä–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞:
   ```xml
   <nsSAFT:Invoice>
     <nsSAFT:InvoiceNo>#{invoice.invoice_no}</nsSAFT:InvoiceNo>
     <nsSAFT:InvoiceDate>#{invoice.issue_date}</nsSAFT:InvoiceDate>
     <nsSAFT:InvoiceType>FT</nsSAFT:InvoiceType>
     <nsSAFT:CustomerID>#{invoice.customer_id}</nsSAFT:CustomerID>
     <nsSAFT:TaxPointDate>#{invoice.tax_event_date}</nsSAFT:TaxPointDate>
     #{Enum.map_join(invoice.items, "\n", &build_invoice_line_xml/1)}
     <nsSAFT:DocumentTotals>
       <nsSAFT:TaxPayable>#{invoice.tax_amount}</nsSAFT:TaxPayable>
       <nsSAFT:NetTotal>#{invoice.subtotal}</nsSAFT:NetTotal>
       <nsSAFT:GrossTotal>#{invoice.total_amount}</nsSAFT:GrossTotal>
     </nsSAFT:DocumentTotals>
   </nsSAFT:Invoice>
   ```

**–í—Ä–µ–º–µ:** ~3-4 —á–∞—Å–∞

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: LiveView –∑–∞ SAF-T (–Ω–∏—Å—ä–∫)

**–ó–∞–¥–∞—á–∞:** UI –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ SAF-T —Ñ–∞–π–ª–æ–≤–µ

**–°—Ç—ä–ø–∫–∏:**
1. –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ LiveView:
   ```elixir
   # lib/cyber_web/live/saft_live/index.ex
   defmodule CyberWeb.SaftLive.Index do
     use CyberWeb, :live_view

     def mount(_params, _session, socket) do
       {:ok, assign(socket,
         year: Date.utc_today().year,
         month: Date.utc_today().month,
         file_type: "monthly",
         generating: false
       )}
     end

     def handle_event("generate", params, socket) do
       # Generate SAF-T file
       {:noreply, socket}
     end
   end
   ```

2. Routing:
   ```elixir
   # lib/cyber_web/router.ex
   live "/saft", SaftLive.Index, :index
   ```

3. UI —Å —Ñ–æ—Ä–º–∞ –∑–∞:
   - –ò–∑–±–æ—Ä –Ω–∞ —Ç–∏–ø (Monthly, Annual, OnDemand)
   - –ò–∑–±–æ—Ä –Ω–∞ –ø–µ—Ä–∏–æ–¥
   - –ë—É—Ç–æ–Ω "–ì–µ–Ω–µ—Ä–∏—Ä–∞–π"
   - –ü—Ä–µ–≥–ª–µ–¥/–∏–∑—Ç–µ–≥–ª—è–Ω–µ –Ω–∞ —Ñ–∞–π–ª

**–í—Ä–µ–º–µ:** ~2-3 —á–∞—Å–∞

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –¢–µ—Å—Ç–æ–≤–µ (–≤–∏—Å–æ–∫)

**–ó–∞–¥–∞—á–∞:** Unit tests –∑–∞ –≤—Å–∏—á–∫–∏ –º–æ–¥—É–ª–∏

**–§–∞–π–ª–æ–≤–µ:**
```
test/cyber_core/accounting/
‚îú‚îÄ‚îÄ vat_test.exs
‚îú‚îÄ‚îÄ nap_export_test.exs
‚îú‚îÄ‚îÄ saft_export_test.exs
‚îî‚îÄ‚îÄ journal_entry_test.exs
```

**–ü—Ä–∏–º–µ—Ä–∏:**
```elixir
# test/cyber_core/accounting/saft_export_test.exs
defmodule CyberCore.Accounting.SaftExportTest do
  use CyberCore.DataCase
  alias CyberCore.Accounting.SaftExport

  test "generate_monthly/4 creates valid XML" do
    {:ok, path} = SaftExport.generate_monthly(1, 2025, 10, "/tmp/test.xml")

    assert File.exists?(path)
    {:ok, content} = File.read(path)
    assert String.contains?(content, "<nsSAFT:AuditFile")
    assert String.contains?(content, "<nsSAFT:Header>")
  end
end
```

**–í—Ä–µ–º–µ:** ~4-6 —á–∞—Å–∞

---

## üìä –û–±—â–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ö–æ–¥:
- **–û–±—â–æ —Ä–µ–¥–æ–≤–µ –∫–æ–¥:** ~4500+
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** ~3000+ —Ä–µ–¥–∞
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** 17+
- **–ú–æ–¥—É–ª–∏:** 30+

### –ü–æ–∫—Ä–∏—Ç–∏–µ:
- **–î–î–° —Å–∏—Å—Ç–µ–º–∞:** 100%
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏:** 100%
- **Multi-Tenant:** 100%
- **SAF-T Header/MasterFiles:** 100%
- **SAF-T GeneralLedger:** 0%
- **SAF-T SourceDocuments:** 0%

### –û—Ü–µ–Ω–∫–∞ –∑–∞ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ:
- **–í—Å–∏—á–∫–æ –æ—Å—Ç–∞–Ω–∞–ª–æ:** ~15-20 —á–∞—Å–∞ —Ä–∞–±–æ—Ç–∞
- **SAF-T –ø—ä–ª–Ω–∞ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è:** ~10-12 —á–∞—Å–∞
- **–¢–µ—Å—Ç–æ–≤–µ:** ~4-6 —á–∞—Å–∞
- **UI:** ~2-3 —á–∞—Å–∞

---

## üéØ –ü—Ä–µ–ø–æ—Ä—ä–∫–∏

### –ó–∞ production —É–ø–æ—Ç—Ä–µ–±–∞:

1. **–ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ:**
   - GeneralLedgerEntries
   - SourceDocuments
   - XSD –≤–∞–ª–∏–¥–∞—Ü–∏—è

2. **–°–∏–ª–Ω–æ –ø—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ:**
   - Unit tests –∑–∞ –≤—Å–∏—á–∫–∏ –º–æ–¥—É–ª–∏
   - Integration tests —Å –ø—Ä–∏–º–µ—Ä–Ω–∏ –¥–∞–Ω–Ω–∏
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–µ—â—É —Ä–µ–∞–ª–Ω–∏ NAP/–ù–ê–ü –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è

3. **–ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ:**
   - LiveView –∑–∞ SAF-T –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ
   - –õ–æ–≥–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ
   - –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ

### –ó–∞ —Ä–∞–∑–≤–∏—Ç–∏–µ:

1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - Batch processing –∑–∞ –≥–æ–ª–µ–º–∏ –æ–±–µ–º–∏ –¥–∞–Ω–Ω–∏
   - Streaming XML generation –∑–∞ –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–∏
   - Background jobs –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ

2. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–¥–∞–≤–∞–Ω–µ –∫—ä–º –ù–ê–ü (–ø—Ä–∏ API)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –¥–∞–Ω–Ω–∏ –ø—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ
   - Preview –Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ

3. **–°–∏–≥—É—Ä–Ω–æ—Å—Ç:**
   - –®–∏—Ñ—Ä–æ–≤–∞–Ω–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ
   - Audit log –∑–∞ –¥–æ—Å—Ç—ä–ø –¥–æ —Ñ–∞–π–ª–æ–≤–µ
   - Role-based access control

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ù–∞–ª–∏—á–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

1. **VAT-docs.md**
   - –ü—ä–ª–Ω–∞ –î–î–° –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è
   - NAP —Ñ–∞–π–ª–æ–≤–µ —Ñ–æ—Ä–º–∞—Ç
   - –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ
   - –ü—Ä–∏–º–µ—Ä–∏ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞

2. **SAFT-docs.md**
   - SAF-T —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   - –†–∞–∑—à–∏—Ä–µ–Ω–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∏
   - XML –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ
   - –¢–∏–ø–æ–≤–µ —Ñ–∞–π–ª–æ–≤–µ

3. **MULTI-TENANT.md** ‚≠ê –ù–û–í–û
   - Multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
   - User-Tenant —Ä–µ–ª–∞—Ü–∏–∏
   - –†–æ–ª–∏ –∏ –¥–æ—Å—Ç—ä–ø
   - LiveView hook –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è
   - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
   - API —Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è
   - –ü—Ä–∏–º–µ—Ä–∏ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞

4. **IMPLEMENTATION-STATUS.md** (—Ç–æ–∑–∏ —Ñ–∞–π–ª)
   - –û–±—â —Å—Ç–∞—Ç—É—Å
   - –ü–ª–∞–Ω –∑–∞ –∑–∞–≤—ä—Ä—à–≤–∞–Ω–µ
   - –ü—Ä–µ–ø–æ—Ä—ä–∫–∏

---

## üîó –†–µ—Ñ–µ—Ä–µ–Ω—Ü–∏–∏

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- –ù–ê–ü –ü–ü–î–° 2025: `/home/dvg/z-nim-proloq/cyber_ERP/FILE/vat-nap/PPDDS_2025_.html`
- SAF-T BG Schema: `/home/dvg/z-nim-proloq/cyber_ERP/FILE/SAFT_BG/BG_SAFT_Schema_V_1.0.1.xsd`
- SAF-T –ø—Ä–∏–º–µ—Ä–∏: `/home/dvg/z-nim-proloq/cyber_ERP/FILE/SAFT_BG/VS_SAMPLE_*.xml`

### –ö–æ–¥–æ–≤–∞ –±–∞–∑–∞:
- Elixir 1.14+
- Phoenix 1.7+
- Ecto 3.10+
- PostgreSQL 14+

---

## üÜï –ü—Ä–æ–º–µ–Ω–∏ –≤ –≤–µ—Ä—Å–∏—è 1.1 (2025-10-21)

### –î–æ–±–∞–≤–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç–∏:

1. **Multi-Tenant —Å–∏—Å—Ç–µ–º–∞**
   - –ü—ä–ª–Ω–∞ –ø–æ–¥–¥—Ä—ä–∂–∫–∞ –∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∏—Ä–º–∏ –≤ –µ–¥–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω–∏
   - Many-to-many —Ä–µ–ª–∞—Ü–∏—è –º–µ–∂–¥—É Users –∏ Tenants
   - –ì–ª–æ–±–∞–ª–µ–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä –∑–∞ –ø—Ä–µ–≤–∫–ª—é—á–≤–∞–Ω–µ –º–µ–∂–¥—É —Ñ–∏—Ä–º–∏
   - UI –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ñ–∏—Ä–º–∏ –Ω–∞ `/tenants`

2. **–û–±–≤—ä—Ä–∑–≤–∞–Ω–µ –Ω–∞ –∞—Ä—Ç–∏–∫—É–ª–∏ —Å—ä—Å —Å—á–µ—Ç–æ–≤–æ–¥–Ω–∏ —Å–º–µ—Ç–∫–∏**
   - –î–æ–±–∞–≤–µ–Ω–æ –ø–æ–ª–µ `account_id` –∫—ä–º products —Ç–∞–±–ª–∏—Ü–∞—Ç–∞
   - Dropdown —Å–µ–ª–µ–∫—Ç–æ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞ –∞—Ä—Ç–∏–∫—É–ª–∏
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å chart of accounts

3. **–ü–æ–¥–æ–±—Ä–µ–Ω–∏—è –≤ Invoices**
   - –î–æ–±–∞–≤–µ–Ω–æ –ø–æ–ª–µ `tax_event_date` (–î–î–° –¥–∞—Ç–∞)
   - Discount –ø–æ–ª–µ—Ç–∞ –Ω–∞ –Ω–∏–≤–æ —Ä–µ–¥
   - –î–∏–Ω–∞–º–∏—á–Ω–∏ –≤–∞–ª—É—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
   - –ü–æ-—à–∏—Ä–æ–∫ modal –ø—Ä–æ–∑–æ—Ä–µ—Ü –∑–∞ —É–¥–æ–±—Å—Ç–≤–æ

4. **Sidebar –æ–ø—Ä–æ—Å—Ç—è–≤–∞–Ω–µ**
   - –ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –æ—Ç–¥–µ–ª–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞—Ä—Ç–∏–∫—É–ª–∏
   - –î–æ–±–∞–≤–µ–Ω –ª–∏–Ω–∫ –∫—ä–º –î–ú–ê (–î—ä–ª–≥–æ—Ç—Ä–∞–π–Ω–∏ –∞–∫—Ç–∏–≤–∏)
   - –ü–æ-—á–∏—Å—Ç –∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–µ–Ω –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–µ–Ω –¥–∏–∑–∞–π–Ω

---

**–ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è:** 2025-10-21 23:00
**–ê–≤—Ç–æ—Ä:** Claude (AI –∞—Å–∏—Å—Ç–µ–Ω—Ç) + dvg
