# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞ –î–î–° –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –≤ Cyber ERP

## –°—ä–¥—ä—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â –ø—Ä–µ–≥–ª–µ–¥](#–æ–±—â-–ø—Ä–µ–≥–ª–µ–¥)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–Ω–∞-—Å–∏—Å—Ç–µ–º–∞—Ç–∞)
3. [–ë–∞–∑–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –¢–∞–±–ª–∏—Ü–∏ –∏ —Å—Ö–µ–º–∏](#–±–∞–∑–æ–≤–∞-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞---—Ç–∞–±–ª–∏—Ü–∏-–∏-—Å—Ö–µ–º–∏)
4. [–î–î–° –î–Ω–µ–≤–Ω–∏—Ü–∏ (–†–µ–≥–∏—Å—Ç—Ä–∏)](#–¥–¥—Å-–¥–Ω–µ–≤–Ω–∏—Ü–∏-—Ä–µ–≥–∏—Å—Ç—Ä–∏)
5. [–î–î–° –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ](#–¥–¥—Å-–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏-–∫–æ–¥–æ–≤–µ)
6. [–î–î–° –°–ø—Ä–∞–≤–∫–∞ (VatReturn)](#–¥–¥—Å-—Å–ø—Ä–∞–≤–∫–∞-vatreturn)
7. [NAP Export - –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ –∑–∞ –ù–ê–ü](#nap-export---–≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ-–Ω–∞-—Ñ–∞–π–ª–æ–≤–µ-–∑–∞-–Ω–∞–ø)
8. [–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∏-–Ω–∞-—Ñ–∏—Ä–º–∞—Ç–∞)
9. [Workflow –∑–∞ —Ä–∞–±–æ—Ç–∞ —Å –î–î–°](#workflow-–∑–∞-—Ä–∞–±–æ—Ç–∞-—Å-–¥–¥—Å)
10. [API Endpoints](#api-endpoints)
11. [–ü—Ä–∏–º–µ—Ä–∏ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞](#–ø—Ä–∏–º–µ—Ä–∏-–∑–∞-—É–ø–æ—Ç—Ä–µ–±–∞)

---

## –û–±—â –ø—Ä–µ–≥–ª–µ–¥

–î–î–° –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è—Ç–∞ –≤ Cyber ERP –µ –±–∞–∑–∏—Ä–∞–Ω–∞ –Ω–∞:
- **–ó–∞–∫–æ–Ω –∑–∞ –¥–∞–Ω—ä–∫ –≤—ä—Ä—Ö—É –¥–æ–±–∞–≤–µ–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç (–ó–î–î–°)**
- **–ü—Ä–∞–≤–∏–ª–Ω–∏–∫ –∑–∞ –ø—Ä–∏–ª–∞–≥–∞–Ω–µ –Ω–∞ –ó–î–î–° (–ü–ü–ó–î–î–°)**
- **–ù–∞—Ä–µ–¥–±–∞ –∑–∞ —É—Å–ª–æ–≤–∏—è—Ç–∞ –∏ —Ä–µ–¥–∞ –∑–∞ –ø–æ–¥–∞–≤–∞–Ω–µ –Ω–∞ –î–î–° –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ (PPDDS_2025)**
- **–¢—ä—Ä–≥–æ–≤—Å–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –∑–∞ —Å—á–µ—Ç–æ–≤–æ–¥—Å—Ç–≤–æ** (–∫–∞—Ç–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç)

–°–∏—Å—Ç–µ–º–∞—Ç–∞ –ø–æ–¥–¥—ä—Ä–∂–∞:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–æ–¥–µ–Ω–µ –Ω–∞ –¥–Ω–µ–≤–Ω–∏—Ü–∏ –∑–∞ –ø–æ–∫—É–ø–∫–∏ –∏ –ø—Ä–æ–¥–∞–∂–±–∏
- ‚úÖ –í—Å–∏—á–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ –∏ –∫–æ–ª–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ –ø–æ –ó–î–î–°
- ‚úÖ VIES –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ (–∫3, –∫4, –∫5) –∑–∞ –í–û–ü/–í–û–î
- ‚úÖ –û–±—Ä–∞—Ç–Ω–æ –Ω–∞—á–∏—Å–ª—è–≤–∞–Ω–µ (reverse charge) —Å –ø–æ–¥–∫–æ–¥–æ–≤–µ
- ‚úÖ –¢—Ä–∏—ä–≥—ä–ª–Ω–∏ —Å–¥–µ–ª–∫–∏
- ‚úÖ –î–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (–ø—ä–ª–µ–Ω, —á–∞—Å—Ç–∏—á–µ–Ω, –±–µ–∑, –Ω–µ–ø—Ä–∏–ª–æ–∂–∏–º–æ)
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ NAP —Ñ–∞–π–ª–æ–≤–µ (DEKLAR.TXT, POKUPKI.TXT, PRODAGBI.TXT)
- ‚úÖ Multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Cyber ERP                         ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ   Invoices   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  VatSalesRegister‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  (–§–∞–∫—Ç—É—Ä–∏)   ‚îÇ      ‚îÇ  (–î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏)       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                 ‚îÇ                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ                   ‚îÇ
‚îÇ  ‚îÇ   Purchases  ‚îÇ               ‚ñº                   ‚îÇ
‚îÇ  ‚îÇ  (–ü–æ–∫—É–ø–∫–∏)   ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇVatPurchaseRegister‚îÇ       ‚îÇ
‚îÇ                        ‚îÇ (–î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏)  ‚îÇ       ‚îÇ
‚îÇ                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                 ‚îÇ                    ‚îÇ
‚îÇ                                 ‚ñº                    ‚îÇ
‚îÇ                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ                        ‚îÇ    VatReturn      ‚îÇ        ‚îÇ
‚îÇ                        ‚îÇ  (–î–î–° —Å–ø—Ä–∞–≤–∫–∞)    ‚îÇ        ‚îÇ
‚îÇ                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                 ‚îÇ                    ‚îÇ
‚îÇ                                 ‚ñº                    ‚îÇ
‚îÇ                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ                        ‚îÇ   NAP Export      ‚îÇ        ‚îÇ
‚îÇ                        ‚îÇ  (–§–∞–π–ª–æ–≤–µ –∑–∞ –ù–ê–ü) ‚îÇ        ‚îÇ
‚îÇ                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                 ‚îÇ                    ‚îÇ
‚îÇ                                 ‚ñº                    ‚îÇ
‚îÇ                    DEKLAR.TXT, POKUPKI.TXT,         ‚îÇ
‚îÇ                       PRODAGBI.TXT                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ë–∞–∑–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ - –¢–∞–±–ª–∏—Ü–∏ –∏ —Å—Ö–µ–º–∏

### –¢–∞–±–ª–∏—Ü–∞: `vat_sales_register`

–î–Ω–µ–≤–Ω–∏–∫ –∑–∞ –ø—Ä–æ–¥–∞–∂–±–∏ —Å–ø–æ—Ä–µ–¥ —á–ª. 124 –æ—Ç –ó–î–î–°.

**–ö–æ–ª–æ–Ω–∏:**
```elixir
schema "vat_sales_register" do
  field :tenant_id, :integer

  # –ü–µ—Ä–∏–æ–¥
  field :period_year, :integer
  field :period_month, :integer

  # –í—Ä—ä–∑–∫–∞ –∫—ä–º —Ñ–∞–∫—Ç—É—Ä–∞
  belongs_to :invoice, Invoice

  # –î–∞–Ω–Ω–∏ –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  field :document_date, :date
  field :tax_event_date, :date
  field :document_type, :string          # "01" - —Ñ–∞–∫—Ç—É—Ä–∞, "02" - –ö–ò, –∏ —Ç.–Ω.
  field :document_number, :string
  field :sales_operation, :string

  # –î–∞–Ω–Ω–∏ –∑–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–∫—É–ø—É–≤–∞—á)
  field :recipient_name, :string
  field :recipient_vat_number, :string
  field :recipient_country, :string
  field :recipient_eik, :string
  field :recipient_city, :string         # –ó–∞ NAP –µ–∫—Å–ø–æ—Ä—Ç

  # –§–∏–Ω–∞–Ω—Å–æ–≤–∏ –¥–∞–Ω–Ω–∏
  field :taxable_base, :decimal          # –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞
  field :vat_rate, :decimal              # –î–î–° —Å—Ç–∞–≤–∫–∞ (20%, 9%, 0%)
  field :vat_amount, :decimal            # –ù–∞—á–∏—Å–ª–µ–Ω –î–î–°
  field :total_amount, :decimal          # –û–±—â–∞ —Å—É–º–∞

  # –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ
  field :vat_operation_code, :string     # "2-11", "2-17", "2-19", –∏ —Ç.–Ω.
  field :column_code, :string            # "–ø—Ä–æ11", "–ø—Ä–æ17", "–ø—Ä–æ19", –∏ —Ç.–Ω.
  field :vies_indicator, :string         # "–∫3", "–∫4", "–∫5" –∏–ª–∏ nil
  field :reverse_charge_subcode, :string # "01", "02" –∏–ª–∏ nil
  field :is_triangular_operation, :boolean
  field :is_art_21_service, :boolean

  field :notes, :string
  timestamps()
end
```

**–í–∞–ª–∏–¥–∞—Ü–∏–∏:**
- –ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏: `tenant_id`, `period_year`, `period_month`, `document_date`, `tax_event_date`, `document_type`, `document_number`, `recipient_name`, `taxable_base`, `vat_rate`, `vat_amount`, `total_amount`
- `period_month` –º–µ–∂–¥—É 1 –∏ 12
- `vat_rate` >= 0
- `vies_indicator` –≤ ["–∫3", "–∫4", "–∫5", nil]
- `reverse_charge_subcode` –≤ ["01", "02", nil]

---

### –¢–∞–±–ª–∏—Ü–∞: `vat_purchase_register`

–î–Ω–µ–≤–Ω–∏–∫ –∑–∞ –ø–æ–∫—É–ø–∫–∏ —Å–ø–æ—Ä–µ–¥ —á–ª. 125 –æ—Ç –ó–î–î–°.

**–ö–æ–ª–æ–Ω–∏:**
```elixir
schema "vat_purchase_register" do
  field :tenant_id, :integer

  # –ü–µ—Ä–∏–æ–¥
  field :period_year, :integer
  field :period_month, :integer

  # –í—Ä—ä–∑–∫–∞ –∫—ä–º –¥–æ–∫—É–º–µ–Ω—Ç (–ø–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞)
  field :document_id, :integer
  field :document_type_table, :string

  # –î–∞–Ω–Ω–∏ –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  field :document_date, :date
  field :tax_event_date, :date
  field :document_type, :string
  field :document_number, :string
  field :purchase_operation, :string

  # –î–∞–Ω–Ω–∏ –∑–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (–¥–æ—Å—Ç–∞–≤—á–∏–∫)
  field :supplier_name, :string
  field :supplier_vat_number, :string
  field :supplier_country, :string
  field :supplier_eik, :string
  field :supplier_city, :string          # –ó–∞ NAP –µ–∫—Å–ø–æ—Ä—Ç

  # –§–∏–Ω–∞–Ω—Å–æ–≤–∏ –¥–∞–Ω–Ω–∏
  field :taxable_base, :decimal
  field :vat_rate, :decimal
  field :vat_amount, :decimal
  field :total_amount, :decimal

  # –ó–∞ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ –Ω–∞ –î–î–°
  field :is_deductible, :boolean
  field :deductible_vat_amount, :decimal

  # –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ
  field :vat_operation_code, :string
  field :column_code, :string
  field :deductible_credit_type, :string  # "full", "partial", "none", "not_applicable"
  field :vies_indicator, :string
  field :reverse_charge_subcode, :string
  field :is_triangular_operation, :boolean
  field :is_art_21_service, :boolean

  field :notes, :string
  timestamps()
end
```

**–í–∞–ª–∏–¥–∞—Ü–∏–∏:**
- –ó–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ –ø–æ–ª–µ—Ç–∞ –∫–∞—Ç–æ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–±–∏—Ç–µ
- `deductible_credit_type` –≤ ["full", "partial", "none", "not_applicable"]
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ `deductible_vat_amount` —Å–ø–æ—Ä–µ–¥ `is_deductible`

---

### –¢–∞–±–ª–∏—Ü–∞: `vat_returns`

–î–î–° —Å–ø—Ä–∞–≤–∫–∞ –∑–∞ –¥–∞–¥–µ–Ω –ø–µ—Ä–∏–æ–¥ (–º–µ—Å–µ—Ü).

**–ö–æ–ª–æ–Ω–∏:**
```elixir
schema "vat_returns" do
  field :tenant_id, :integer
  field :period_year, :integer
  field :period_month, :integer

  # –ü—Ä–æ–¥–∞–∂–±–∏ (–∏–∑—Ö–æ–¥—è—â –î–î–°)
  field :total_sales_taxable, :decimal    # –û–±—â–æ –¥–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –ø—Ä–æ–¥–∞–∂–±–∏
  field :total_sales_vat, :decimal        # –û–±—â–æ –Ω–∞—á–∏—Å–ª–µ–Ω –î–î–° –ø—Ä–æ–¥–∞–∂–±–∏

  # –ü–æ–∫—É–ø–∫–∏ (–≤—Ö–æ–¥—è—â –î–î–°)
  field :total_purchase_taxable, :decimal # –û–±—â–æ –¥–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –ø–æ–∫—É–ø–∫–∏
  field :total_purchase_vat, :decimal     # –û–±—â–æ –î–î–° –ø–æ –ø–æ–∫—É–ø–∫–∏
  field :total_deductible_vat, :decimal   # –û–±—â–æ –î–î–° –∑–∞ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ

  # –†–µ–∑—É–ª—Ç–∞—Ç
  field :vat_to_pay, :decimal             # –î–î–° –∑–∞ –≤–Ω–∞—Å—è–Ω–µ
  field :vat_to_refund, :decimal          # –î–î–° –∑–∞ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ

  # –°—Ç–∞—Ç—É—Å
  field :status, :string                  # "draft", "submitted", "paid"
  field :submission_date, :date
  field :payment_date, :date

  field :notes, :string
  timestamps()
end
```

---

### –¢–∞–±–ª–∏—Ü–∞: `vat_operation_codes`

–†–µ—Ñ–µ—Ä–µ–Ω—Ç–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –≤—Å–∏—á–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ –ø–æ –ó–î–î–°.

**–ö–æ–ª–æ–Ω–∏:**
```elixir
schema "vat_operation_codes" do
  field :code, :string                    # "1-10-1", "2-11", –∏ —Ç.–Ω.
  field :name, :string                    # –ò–º–µ –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è—Ç–∞
  field :description, :string
  field :operation_type, :string          # "sale" –∏–ª–∏ "purchase"
  field :column_code, :string             # "–ø—Ä–æ11", "–ø–æ–∫09", –∏ —Ç.–Ω.
  field :vat_rate, :decimal
  field :is_reverse_charge, :boolean
  field :is_intra_community, :boolean
  field :is_export, :boolean
  field :is_import, :boolean
  field :requires_vies_indicator, :boolean
  field :allows_partial_credit, :boolean

  timestamps()
end
```

---

### –¢–∞–±–ª–∏—Ü–∞: `company_settings`

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (–∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –∑–∞ NAP –µ–∫—Å–ø–æ—Ä—Ç).

**–ö–æ–ª–æ–Ω–∏:**
```elixir
schema "company_settings" do
  field :tenant_id, :integer

  # –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  field :company_name, :string
  field :vat_number, :string              # BGxxxxxxxxx
  field :eik, :string
  field :address, :string
  field :city, :string
  field :phone, :string
  field :email, :string

  # –ë–∞–Ω–∫–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  field :bank_name, :string
  field :bank_bic, :string
  field :bank_iban, :string

  # –î–î–° –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  field :is_vat_registered, :boolean
  field :vat_registration_date, :date
  field :country, :string
  field :default_currency, :string
  field :default_vat_rate, :decimal

  timestamps()
end
```

**–í–∞–ª–∏–¥–∞—Ü–∏–∏:**
- `vat_number` —Ñ–æ—Ä–º–∞—Ç: `~r/^BG\d{9,10}$/`
- `eik` —Ñ–æ—Ä–º–∞—Ç: `~r/^\d{9,13}$/`
- –£–Ω–∏–∫–∞–ª–µ–Ω constraint –ø–æ `tenant_id`

---

## –î–î–° –î–Ω–µ–≤–Ω–∏—Ü–∏ (–†–µ–≥–∏—Å—Ç—Ä–∏)

### –î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏ (Sales Register)

**–§–∞–π–ª:** `apps/cyber_core/lib/cyber_core/accounting/vat_sales_register.ex`

**–û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:**

```elixir
# –°—ä–∑–¥–∞–≤–∞ –∑–∞–ø–∏—Å –≤ –¥–Ω–µ–≤–Ω–∏–∫–∞ –æ—Ç —Ñ–∞–∫—Ç—É—Ä–∞
VatSalesRegister.from_invoice(%Invoice{})

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è VAT operation code —Å–ø–æ—Ä–µ–¥ —Å—Ç–∞–≤–∫–∞—Ç–∞
defp determine_vat_operation_code(invoice, vat_rate)
  # 20% -> {"2-11", "–ø—Ä–æ11"}
  # 9%  -> {"2-17", "–ø—Ä–æ17"}
  # 0%  -> —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ –∫–æ–¥–æ–≤–µ —Å–ø–æ—Ä–µ–¥ –≤–∏–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∞
```

**Changeset:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ VIES –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –ï–° –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∏
- –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –î–î–° —Å—Ç–∞–≤–∫–∞ –æ—Ç –¥–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –∏ –î–î–° —Å—É–º–∞

---

### –î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏ (Purchase Register)

**–§–∞–π–ª:** `apps/cyber_core/lib/cyber_core/accounting/vat_purchase_register.ex`

**–û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:**

```elixir
# –ò–∑—á–∏—Å–ª—è–≤–∞ –¥–µductible VAT –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
defp calculate_deductible_vat(changeset)
```

**Changeset:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ `deductible_vat_amount`
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ `deductible_credit_type` (full/partial/none/not_applicable)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ reverse charge —Å—É–±–∫–æ–¥

---

## –î–î–° –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ

### –ü—Ä–æ–¥–∞–∂–±–∏ (Sales Operation Codes)

| –ö–æ–¥ | –ò–º–µ | –ö–æ–ª–æ–Ω–∞ | –î–î–° % | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|-----|--------|-------|----------|
| 2-11 | –î–∞–Ω—ä—á–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ 20% | –ø—Ä–æ11 | 20.00 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Å—Ç–∞–≤–∫–∞ |
| 2-12 | –í–û–ü (–≤—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –ø–æ–∫—É–ø–∫–∞) | –ø—Ä–æ12 | 20.00 | –ù–∞—á–∏—Å–ª—è–≤–∞–Ω–µ –ø—Ä–∏ –í–û–ü |
| 2-17 | –î–∞–Ω—ä—á–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ 9% | –ø—Ä–æ17 | 9.00 | –ù–∞–º–∞–ª–µ–Ω–∞ —Å—Ç–∞–≤–∫–∞ |
| 2-19 | –î–æ—Å—Ç–∞–≤–∫–∏ 0% —á–ª. 140, 146, 173 | –ø—Ä–æ19 | 0.00 | –ï–∫—Å–ø–æ—Ä—Ç –∏ –ø–æ–¥–æ–±–Ω–∏ |
| 2-20 | –í–û–î (–≤—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞) | –ø—Ä–æ20 | 0.00 | IC supplies |
| 2-23 | –û—Å–≤–æ–±–æ–¥–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ | –ø—Ä–æ23 | 0.00 | –ß–ª. 26, 28, 32, 34, 47 –ó–î–î–° |

### –ü–æ–∫—É–ø–∫–∏ (Purchase Operation Codes)

| –ö–æ–¥ | –ò–º–µ | –ö–æ–ª–æ–Ω–∞ | –î–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|-----|--------|----------------|----------|
| 1-10-1 | –ü–æ–∫—É–ø–∫–∏ 20% –ø—ä–ª–µ–Ω –∫—Ä–µ–¥–∏—Ç | –ø–æ–∫09 | full | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Å—Ç–∞–≤–∫–∞ |
| 1-10-2 | –ü–æ–∫—É–ø–∫–∏ 20% —á–∞—Å—Ç–∏—á–µ–Ω –∫—Ä–µ–¥–∏—Ç | –ø–æ–∫10 | partial | –° –∫–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç |
| 1-10-3 | –ü–æ–∫—É–ø–∫–∏ 20% –±–µ–∑ –∫—Ä–µ–¥–∏—Ç | - | none | –ù–µ–æ–±–ª–∞–≥–∞–µ–º–∞ –¥–µ–π–Ω–æ—Å—Ç |
| 1-11 | –í–û–ü 20% | –ø–æ–∫09 | full | –í—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –ø–æ–∫—É–ø–∫–∞ |
| 1-17 | –ü–æ–∫—É–ø–∫–∏ 9% | –ø–æ–∫09 | full | –ù–∞–º–∞–ª–µ–Ω–∞ —Å—Ç–∞–≤–∫–∞ |

### VIES –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏

- **–∫3** - –í—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ (–í–û–î)
- **–∫4** - –í—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –ø–æ–∫—É–ø–∫–∞ (–í–û–ü)
- **–∫5** - –¢—Ä–∏—ä–≥—ä–ª–Ω–∞ —Å–¥–µ–ª–∫–∞

### Reverse Charge —Å—É–±–∫–æ–¥–æ–≤–µ

- **01** - –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ —á–ª. 163–∞
- **02** - –í–Ω–æ—Å –ø–æ —á–ª. 167–∞

---

## –î–î–° –°–ø—Ä–∞–≤–∫–∞ (VatReturn)

**–§–∞–π–ª:** `apps/cyber_core/lib/cyber_core/accounting/vat.ex`

### –û—Å–Ω–æ–≤–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏:

```elixir
# –°—ä–∑–¥–∞–≤–∞ –∏–ª–∏ –≤–∑–µ–º–∞ —Å–ø—Ä–∞–≤–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
Vat.get_or_create_vat_return(tenant_id, year, month)

# –ò–∑—á–∏—Å–ª—è–≤–∞ —Å–ø—Ä–∞–≤–∫–∞—Ç–∞ –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ç–µ
Vat.calculate_vat_return(tenant_id, year, month)

# –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
Vat.update_vat_return(vat_return, %{status: "submitted"})
```

### Workflow –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ:

1. –°—É–º–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –∑–∞–ø–∏—Å–∏ –æ—Ç `vat_sales_register` –∑–∞ –ø–µ—Ä–∏–æ–¥–∞
2. –°—É–º–∏—Ä–∞ –≤—Å–∏—á–∫–∏ –∑–∞–ø–∏—Å–∏ –æ—Ç `vat_purchase_register` –∑–∞ –ø–µ—Ä–∏–æ–¥–∞
3. –ò–∑—á–∏—Å–ª—è–≤–∞ –æ–±—â–æ –Ω–∞—á–∏—Å–ª–µ–Ω –î–î–° (–∏–∑—Ö–æ–¥—è—â)
4. –ò–∑—á–∏—Å–ª—è–≤–∞ –æ–±—â–æ –î–î–° –∑–∞ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ (–≤—Ö–æ–¥—è—â)
5. –ò–∑—á–∏—Å–ª—è–≤–∞ —Ä–∞–∑–ª–∏–∫–∞:
   - –ê–∫–æ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞ ‚Üí `vat_to_pay`
   - –ê–∫–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞ ‚Üí `vat_to_refund`

---

## NAP Export - –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ –∑–∞ –ù–ê–ü

**–§–∞–π–ª:** `apps/cyber_core/lib/cyber_core/accounting/nap_export.ex`

### –û–±—â –ø—Ä–µ–≥–ª–µ–¥

–ì–µ–Ω–µ—Ä–∏—Ä–∞ —Ç—Ä–∏ —Ç–µ–∫—Å—Ç–æ–≤–∏ —Ñ–∞–π–ª–∞ –∑–∞ –ø–æ–¥–∞–≤–∞–Ω–µ –≤ –ù–ê–ü:
- **DEKLAR.TXT** - –î–µ–∫–ª–∞—Ä–∞—Ü–∏—è (–æ–±–æ–±—â–µ–Ω–∏–µ)
- **POKUPKI.TXT** - –î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
- **PRODAGBI.TXT** - –î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏

**–§–æ—Ä–º–∞—Ç:**
- –ö–æ–¥–∏—Ä–æ–≤–∫–∞: windows-1251 (cp-1251) ‚ö†Ô∏è TODO: –ò–∑–∏—Å–∫–≤–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `codepagex`
- –ë–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (fixed-width fields)
- –ß–∏—Å–ª–∞ –ø–æ–¥—Ä–∞–≤–Ω–µ–Ω–∏ –≤–¥—è—Å–Ω–æ
- –¢–µ–∫—Å—Ç –ø–æ–¥—Ä–∞–≤–Ω–µ–Ω –≤–ª—è–≤–æ
- –î–∞—Ç–∏: dd/mm/yyyy
- –ö—Ä–∞–π –Ω–∞ —Ä–µ–¥: CRLF (\r\n)

### –§—É–Ω–∫—Ü–∏—è –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ —Ñ–∞–π–ª–æ–≤–µ:

```elixir
NapExport.generate_nap_files(tenant_id, year, month, "/path/to/output")
# Returns: {:ok, %{deklar: path, pokupki: path, prodagbi: path}}
```

---

### DEKLAR.TXT (–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è)

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:** 31 –ø–æ–ª–µ—Ç–∞ —Å —Ñ–∏–∫—Å–∏—Ä–∞–Ω–∞ –¥—ä–ª–∂–∏–Ω–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```
–ü–æ–ª–µ 00-01: –î–î–° –Ω–æ–º–µ—Ä (15 chars)
–ü–æ–ª–µ 00-02: –ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞ (50 chars)
–ü–æ–ª–µ 00-03: –ü–µ—Ä–∏–æ–¥ YYYYMM (6 chars)
–ü–æ–ª–µ 00-04: –ü–æ–¥–∞–≤–∞—â –ª–∏—Ü–µ (50 chars)
–ü–æ–ª–µ 00-05: –ë—Ä–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∏ –ø—Ä–æ–¥–∞–∂–±–∏ (15 chars)
–ü–æ–ª–µ 00-06: –ë—Ä–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∏ –ø–æ–∫—É–ø–∫–∏ (15 chars)

--- –ü–†–û–î–ê–ñ–ë–ò ---
–ü–æ–ª–µ 01-01: –û–±—â–∞ –¥–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ (15 chars)
–ü–æ–ª–µ 01-20: –û–±—â–æ –Ω–∞—á–∏—Å–ª–µ–Ω –î–î–° (15 chars)
–ü–æ–ª–µ 01-11: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 20% (15 chars)
–ü–æ–ª–µ 01-21: –î–î–° 20% (15 chars)
–ü–æ–ª–µ 01-12: –í–û–ü –¥–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ (15 chars)
–ü–æ–ª–µ 01-22: –í–û–ü –î–î–° (15 chars)
–ü–æ–ª–µ 01-23: –î–î–° –∑–∞ –ª–∏—á–Ω–æ –ø–æ–ª–∑–≤–∞–Ω–µ (15 chars)
–ü–æ–ª–µ 01-13: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 9% (15 chars)
–ü–æ–ª–µ 01-24: –î–î–° 9% (15 chars)
–ü–æ–ª–µ 01-14: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 0% —á–ª.3 (15 chars)
–ü–æ–ª–µ 01-15: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 0% –í–û–î (15 chars)
–ü–æ–ª–µ 01-16: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 0% —á–ª.140/146/173 (15 chars)
–ü–æ–ª–µ 01-17: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —É—Å–ª—É–≥–∏ —á–ª.21 (15 chars)
–ü–æ–ª–µ 01-18: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —á–ª.69 (15 chars)
–ü–æ–ª–µ 01-19: –û—Å–≤–æ–±–æ–¥–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (15 chars)

--- –ü–û–ö–£–ü–ö–ò ---
–ü–æ–ª–µ 01-30: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –±–µ–∑ –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 01-31: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –ø—ä–ª–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 01-41: –î–î–° –ø—ä–ª–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 01-32: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —á–∞—Å—Ç–∏—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 01-42: –î–î–° —á–∞—Å—Ç–∏—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 01-43: –ì–æ–¥–∏—à–Ω–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–µ (15 chars)

--- –†–ï–ó–£–õ–¢–ê–¢ ---
–ü–æ–ª–µ 01-33: –ö–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç (4 chars)
–ü–æ–ª–µ 01-40: –û–±—â –¥–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 01-50: –î–î–° –∑–∞ –≤–Ω–∞—Å—è–Ω–µ (15 chars)
–ü–æ–ª–µ 01-60: –î–î–° –∑–∞ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ (15 chars)
```

**–ò–∑—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª–µ—Ç–∞—Ç–∞:**

–î–∞–Ω–Ω–∏—Ç–µ —Å–µ –≤–∑–µ–º–∞—Ç –¥–∏–Ω–∞–º–∏—á–Ω–æ –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ç–µ:
- –ê–≥—Ä–µ–≥–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–¥–∞–∂–±–∏ –ø–æ `column_code` (–ø—Ä–æ11, –ø—Ä–æ17, –ø—Ä–æ19, –ø—Ä–æ20, –ø—Ä–æ23)
- –ê–≥—Ä–µ–≥–∏—Ä–∞–Ω–µ –Ω–∞ –ø–æ–∫—É–ø–∫–∏ –ø–æ `deductible_credit_type` (full, partial, none)
- –ë—Ä–æ–µ–Ω–µ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (–±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∏ 11, 12, 13, 04, 94, 05)

---

### POKUPKI.TXT (–î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏)

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:** 16 –ø–æ–ª–µ—Ç–∞ —Å —Ñ–∏–∫—Å–∏—Ä–∞–Ω–∞ –¥—ä–ª–∂–∏–Ω–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ä–µ–¥:**

```
–ü–æ–ª–µ 03-02: –î–î–° –Ω–æ–º–µ—Ä –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (15 chars)
–ü–æ–ª–µ 03-01: –ü–µ—Ä–∏–æ–¥ YYYYMM (6 chars)
–ü–æ–ª–µ 03-03: –û–±–æ—Å–æ–±–µ–Ω–∞ —á–∞—Å—Ç (4 chars)
–ü–æ–ª–µ 03-04: –ü–æ—Ä–µ–¥–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ –∑–∞–ø–∏—Å–∞ (15 chars)
–ü–æ–ª–µ 03-05: –í–∏–¥ –¥–æ–∫—É–º–µ–Ω—Ç (2 chars) - "01", "02", –∏ —Ç.–Ω.
      –ü—Ä–∞–∑–Ω–æ (14 chars)
–ü–æ–ª–µ 03-06: –ù–æ–º–µ—Ä –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (20 chars)
–ü–æ–ª–µ 03-07: –î–∞—Ç–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç dd/mm/yyyy (10 chars)
–ü–æ–ª–µ 03-08: –î–î–°/–ï–ò–ö –Ω–∞ –¥–æ—Å—Ç–∞–≤—á–∏–∫ (15 chars)
–ü–æ–ª–µ 03-09: –ò–º–µ –Ω–∞ –¥–æ—Å—Ç–∞–≤—á–∏–∫ (50 chars)
–ü–æ–ª–µ 03-10: –ì—Ä–∞–¥ –Ω–∞ –¥–æ—Å—Ç–∞–≤—á–∏–∫ (30 chars)
–ü–æ–ª–µ 03-30: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –±–µ–∑ –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 03-31: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –ø—ä–ª–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 03-41: –î–î–° –ø—ä–ª–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 03-32: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —á–∞—Å—Ç–∏—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 03-42: –î–î–° —á–∞—Å—Ç–∏—á–µ–Ω –∫—Ä–µ–¥–∏—Ç (15 chars)
–ü–æ–ª–µ 03-43: –ì–æ–¥–∏—à–Ω–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–µ (15 chars)
–ü–æ–ª–µ 03-44: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —Ç—Ä–∏—ä–≥—ä–ª–Ω–∞ —Å–¥–µ–ª–∫–∞ (15 chars)
–ü–æ–ª–µ 03-45: –î–æ—Å—Ç–∞–≤–∫–∞ —á–ª.163–∞/–≤–Ω–æ—Å —á–ª.167–∞ (2 chars) - "01", "02"
```

**–õ–æ–≥–∏–∫–∞ –∑–∞ –ø–æ–ø—ä–ª–≤–∞–Ω–µ:**

```elixir
# –ü–æ deductible_credit_type —Å–µ –ø–æ–ø—ä–ª–≤–∞—Ç —Ä–∞–∑–ª–∏—á–Ω–∏ –ø–æ–ª–µ—Ç–∞:
get_purchase_amount_by_credit(purchase, :none)     # -> 03-30
get_purchase_amount_by_credit(purchase, :full)     # -> 03-31
get_purchase_vat_by_credit(purchase, :full)        # -> 03-41
get_purchase_amount_by_credit(purchase, :partial)  # -> 03-32
get_purchase_vat_by_credit(purchase, :partial)     # -> 03-42
```

---

### PRODAGBI.TXT (–î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏)

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:** 28 –ø–æ–ª–µ—Ç–∞ —Å —Ñ–∏–∫—Å–∏—Ä–∞–Ω–∞ –¥—ä–ª–∂–∏–Ω–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ä–µ–¥:**

```
–ü–æ–ª–µ 02-00: –î–î–° –Ω–æ–º–µ—Ä –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞ (15 chars)
–ü–æ–ª–µ 02-01: –ü–µ—Ä–∏–æ–¥ YYYYMM (6 chars)
–ü–æ–ª–µ 02-02: –û–±–æ—Å–æ–±–µ–Ω–∞ —á–∞—Å—Ç (4 chars)
–ü–æ–ª–µ 02-03: –ü–æ—Ä–µ–¥–µ–Ω –Ω–æ–º–µ—Ä –Ω–∞ –∑–∞–ø–∏—Å–∞ (15 chars)
–ü–æ–ª–µ 02-04: –í–∏–¥ –¥–æ–∫—É–º–µ–Ω—Ç (2 chars)
–ü–æ–ª–µ 02-05: –ù–æ–º–µ—Ä –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (20 chars)
–ü–æ–ª–µ 02-06: –î–∞—Ç–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç dd/mm/yyyy (10 chars)
–ü–æ–ª–µ 02-07: –î–î–°/–ï–ò–ö –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª (15 chars)
–ü–æ–ª–µ 02-08: –ò–º–µ –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª (50 chars)
–ü–æ–ª–µ 02-09: –ì—Ä–∞–¥ –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª (30 chars)
–ü–æ–ª–µ 02-10: –û–±—â–æ –¥–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ (15 chars)
–ü–æ–ª–µ 02-20: –û–±—â–æ –î–î–° (15 chars)
–ü–æ–ª–µ 02-11: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 20% (15 chars)
–ü–æ–ª–µ 02-21: –î–î–° 20% (15 chars)
–ü–æ–ª–µ 02-12: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –í–û–ü (15 chars)
–ü–æ–ª–µ 02-26: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —á–ª.82 (15 chars)
–ü–æ–ª–µ 02-22: –î–î–° –∑–∞ –í–û–ü –∏ —á–ª.82 (15 chars)
–ü–æ–ª–µ 02-23: –î–î–° –∑–∞ –ª–∏—á–Ω–æ –ø–æ–ª–∑–≤–∞–Ω–µ (15 chars)
–ü–æ–ª–µ 02-13: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 9% (15 chars)
–ü–æ–ª–µ 02-24: –î–î–° 9% (15 chars)
–ü–æ–ª–µ 02-14: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 0% –≥–ª–∞–≤–∞ 3 (15 chars)
–ü–æ–ª–µ 02-15: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 0% –í–û–î (15 chars)
–ü–æ–ª–µ 02-16: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ 0% —á–ª.140/146/173 (15 chars)
–ü–æ–ª–µ 02-17: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —É—Å–ª—É–≥–∏ —á–ª.21 –ø–∞—Ä.2 (15 chars)
–ü–æ–ª–µ 02-18: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —á–ª.69 –ø–∞—Ä.2 (15 chars)
–ü–æ–ª–µ 02-19: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ –æ—Å–≤–æ–±–æ–¥–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (15 chars)
–ü–æ–ª–µ 02-25: –î–∞–Ω—ä—á–Ω–∞ –æ—Å–Ω–æ–≤–∞ —Ç—Ä–∏—ä–≥—ä–ª–Ω–∏ —Å–¥–µ–ª–∫–∏ (15 chars)
–ü–æ–ª–µ 02-27: –î–æ—Å—Ç–∞–≤–∫–∞ —á–ª.163–∞/–≤–Ω–æ—Å —á–ª.167–∞ (2 chars)
```

**–õ–æ–≥–∏–∫–∞ –∑–∞ –ø–æ–ø—ä–ª–≤–∞–Ω–µ:**

```elixir
# –ü–æ column_code —Å–µ –ø–æ–ø—ä–ª–≤–∞—Ç —Ä–∞–∑–ª–∏—á–Ω–∏ –ø–æ–ª–µ—Ç–∞:
get_column_amount(sale, "–ø—Ä–æ11")  # -> 02-11 (–±–∞–∑–∞ 20%)
get_column_vat(sale, "–ø—Ä–æ11")     # -> 02-21 (–î–î–° 20%)
get_column_amount(sale, "–ø—Ä–æ17")  # -> 02-13 (–±–∞–∑–∞ 9%)
get_column_vat(sale, "–ø—Ä–æ17")     # -> 02-24 (–î–î–° 9%)
get_column_amount(sale, "–ø—Ä–æ19")  # -> 02-14 (–±–∞–∑–∞ 0% —á–ª.3)
get_column_amount(sale, "–ø—Ä–æ20")  # -> 02-15 (–±–∞–∑–∞ 0% –í–û–î)
get_column_amount(sale, "–ø—Ä–æ23")  # -> 02-19 (–æ—Å–≤–æ–±–æ–¥–µ–Ω–∏)
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞

**–§–∞–π–ª:** `apps/cyber_core/lib/cyber_core/settings.ex`

### –§—É–Ω–∫—Ü–∏–∏:

```elixir
# –í–∑–µ–º–∞ –∏–ª–∏ —Å—ä–∑–¥–∞–≤–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –∑–∞ tenant
Settings.get_or_create_company_settings(tenant_id)

# –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
Settings.update_company_settings(settings, %{vat_number: "BG123456789"})

# –ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ —Ñ–∏—Ä–º–∞—Ç–∞ –µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∞ –ø–æ –î–î–°
Settings.is_vat_registered?(tenant_id)

# –í–∑–µ–º–∞ –î–î–° –Ω–æ–º–µ—Ä–∞ (–∏–∑–ø–æ–ª–∑–≤–∞–Ω–æ –≤ NAP export)
Settings.get_vat_number(tenant_id)
```

### LiveView –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è:

**–ü—ä—Ç:** `/settings`

**–§–∞–π–ª:** `apps/cyber_web/lib/cyber_web/live/settings_live/index.ex`

**–§–æ—Ä–º–∞ –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è –Ω–∞:**
- –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∏–º–µ, –î–î–° –Ω–æ–º–µ—Ä, –ï–ò–ö, –∞–¥—Ä–µ—Å, –≥—Ä–∞–¥, —Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º–µ–π–ª)
- –ë–∞–Ω–∫–æ–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–±–∞–Ω–∫–∞, BIC, IBAN)

---

## Workflow –∑–∞ —Ä–∞–±–æ—Ç–∞ —Å –î–î–°

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞

```elixir
# –ü—Ä–∏ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞
{:ok, settings} = Settings.get_or_create_company_settings(tenant_id)

Settings.update_company_settings(settings, %{
  company_name: "–ú–æ—è—Ç–∞ —Ñ–∏—Ä–º–∞ –ï–û–û–î",
  vat_number: "BG123456789",
  eik: "123456789",
  address: "—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞ 1",
  city: "–°–æ—Ñ–∏—è",
  is_vat_registered: true
})
```

### 2. –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞

```elixir
# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ (Sales –º–æ–¥—É–ª)
{:ok, invoice} = Sales.create_invoice(%{
  tenant_id: 1,
  invoice_no: "0000000001",
  issue_date: ~D[2025-10-15],
  tax_event_date: ~D[2025-10-15],
  billing_name: "–ö–ª–∏–µ–Ω—Ç –û–û–î",
  billing_vat_number: "BG987654321",
  subtotal: Decimal.new("100.00"),
  tax_amount: Decimal.new("20.00"),
  total_amount: Decimal.new("120.00"),
  vat_document_type: "01",
  vat_sales_operation: "2-11"
})
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ –≤ –¥–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏

```elixir
# –¢–æ–≤–∞ —Å–µ –∏–∑–≤–∏–∫–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞
sales_register_attrs = VatSalesRegister.from_invoice(invoice)

{:ok, sales_register} = Repo.insert(
  VatSalesRegister.changeset(%VatSalesRegister{}, sales_register_attrs)
)
```

### 4. –ó–∞–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ –ø–æ–∫—É–ø–∫–∞ –≤ –¥–Ω–µ–≤–Ω–∏–∫

```elixir
# –†—ä—á–Ω–æ –∏–ª–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç –æ—Ç –¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏
{:ok, purchase_register} = Repo.insert(
  VatPurchaseRegister.changeset(%VatPurchaseRegister{}, %{
    tenant_id: 1,
    period_year: 2025,
    period_month: 10,
    document_date: ~D[2025-10-10],
    tax_event_date: ~D[2025-10-10],
    document_type: "01",
    document_number: "FA-123",
    supplier_name: "–î–æ—Å—Ç–∞–≤—á–∏–∫ –û–û–î",
    supplier_vat_number: "BG111222333",
    supplier_city: "–ü–ª–æ–≤–¥–∏–≤",
    taxable_base: Decimal.new("500.00"),
    vat_rate: Decimal.new("20.00"),
    vat_amount: Decimal.new("100.00"),
    total_amount: Decimal.new("600.00"),
    is_deductible: true,
    deductible_credit_type: "full",
    vat_operation_code: "1-10-1",
    column_code: "–ø–æ–∫09"
  })
)
```

### 5. –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –î–î–° —Å–ø—Ä–∞–≤–∫–∞ –∑–∞ –º–µ—Å–µ—Ü

```elixir
# –ù–∞–∫—Ä–∞—è –Ω–∞ –º–µ—Å–µ—Ü–∞
{:ok, vat_return} = Vat.calculate_vat_return(tenant_id, 2025, 10)

# vat_return —Å—ä–¥—ä—Ä–∂–∞:
# - total_sales_taxable: 100.00
# - total_sales_vat: 20.00
# - total_purchase_taxable: 500.00
# - total_purchase_vat: 100.00
# - total_deductible_vat: 100.00
# - vat_to_pay: 0.00
# - vat_to_refund: 80.00
```

### 6. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ NAP —Ñ–∞–π–ª–æ–≤–µ

```elixir
# –ó–∞ –ø–æ–¥–∞–≤–∞–Ω–µ –≤ –ù–ê–ü
{:ok, files} = NapExport.generate_nap_files(tenant_id, 2025, 10, "/tmp")

# files = %{
#   deklar: "/tmp/DEKLAR.TXT",
#   pokupki: "/tmp/POKUPKI.TXT",
#   prodagbi: "/tmp/PRODAGBI.TXT"
# }
```

### 7. –ü–æ–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è—Ç–∞

```elixir
# –ú–∞—Ä–∫–∏—Ä–∞–Ω–µ –∫–∞—Ç–æ –ø–æ–¥–∞–¥–µ–Ω–∞
Vat.update_vat_return(vat_return, %{
  status: "submitted",
  submission_date: Date.utc_today()
})
```

---

## API Endpoints

### Accounting API

**Base path:** `/api/accounting`

#### Journal Entries
```
GET    /api/accounting/journal-entries
POST   /api/accounting/journal-entries
GET    /api/accounting/journal-entries/:id
PUT    /api/accounting/journal-entries/:id
DELETE /api/accounting/journal-entries/:id
```

#### Accounts
```
GET    /api/accounting/accounts
POST   /api/accounting/accounts
GET    /api/accounting/accounts/:id
PUT    /api/accounting/accounts/:id
DELETE /api/accounting/accounts/:id
```

#### VAT (–ø—Ä–µ–¥—Å—Ç–æ—è—â–æ API)
```
GET    /api/vat/returns              # –°–ø–∏—Å—ä–∫ –Ω–∞ –î–î–° —Å–ø—Ä–∞–≤–∫–∏
GET    /api/vat/returns/:year/:month # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —Å–ø—Ä–∞–≤–∫–∞
POST   /api/vat/calculate            # –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ —Å–ø—Ä–∞–≤–∫–∞
GET    /api/vat/sales-register       # –î–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏
GET    /api/vat/purchase-register    # –î–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
POST   /api/vat/nap-export           # –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ NAP —Ñ–∞–π–ª–æ–≤–µ
```

---

## –ü—Ä–∏–º–µ—Ä–∏ –∑–∞ —É–ø–æ—Ç—Ä–µ–±–∞

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ–¥–∞–∂–±–∞ –≤ –ë—ä–ª–≥–∞—Ä–∏—è (20% –î–î–°)

```elixir
# –§–∞–∫—Ç—É—Ä–∞ –∫—ä–º –±—ä–ª–≥–∞—Ä—Å–∫–∏ –∫–ª–∏–µ–Ω—Ç
invoice_attrs = %{
  tenant_id: 1,
  invoice_no: "0000000001",
  issue_date: ~D[2025-10-15],
  tax_event_date: ~D[2025-10-15],
  billing_name: "–ö–ª–∏–µ–Ω—Ç –û–û–î",
  billing_vat_number: "BG987654321",
  billing_company_id: "987654321",
  subtotal: Decimal.new("1000.00"),
  tax_amount: Decimal.new("200.00"),
  total_amount: Decimal.new("1200.00"),
  vat_document_type: "01",
  vat_sales_operation: "2-11"
}

{:ok, invoice} = Sales.create_invoice(invoice_attrs)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ —Å—ä–∑–¥–∞–≤–∞ –∑–∞–ø–∏—Å –≤ vat_sales_register:
# - vat_operation_code: "2-11"
# - column_code: "–ø—Ä–æ11"
# - vat_rate: 20.00
# - taxable_base: 1000.00
# - vat_amount: 200.00
```

### –ü—Ä–∏–º–µ—Ä 2: –í–û–î (–≤—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞)

```elixir
# –ü—Ä–æ–¥–∞–∂–±–∞ –∫—ä–º —Ñ–∏—Ä–º–∞ –≤ –ï–° (0% –î–î–°)
invoice_attrs = %{
  tenant_id: 1,
  invoice_no: "0000000002",
  issue_date: ~D[2025-10-16],
  tax_event_date: ~D[2025-10-16],
  billing_name: "German Company GmbH",
  billing_vat_number: "DE123456789",  # –ì–µ—Ä–º–∞–Ω—Å–∫–∏ –î–î–° –Ω–æ–º–µ—Ä
  subtotal: Decimal.new("2000.00"),
  tax_amount: Decimal.new("0.00"),
  total_amount: Decimal.new("2000.00"),
  vat_document_type: "01",
  vat_sales_operation: "2-20"
}

{:ok, invoice} = Sales.create_invoice(invoice_attrs)

# –í vat_sales_register:
# - vat_operation_code: "2-20"
# - column_code: "–ø—Ä–æ20"
# - vies_indicator: "–∫3"
# - vat_rate: 0.00
# - taxable_base: 2000.00
# - vat_amount: 0.00
```

### –ü—Ä–∏–º–µ—Ä 3: –ü–æ–∫—É–ø–∫–∞ —Å –ø—ä–ª–µ–Ω –¥–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç

```elixir
# –ü–æ–∫—É–ø–∫–∞ –æ—Ç –¥–æ—Å—Ç–∞–≤—á–∏–∫ —Å –ø—Ä–∞–≤–æ –Ω–∞ –ø—ä–ª–Ω–æ –ø—Ä–∏—Å–ø–∞–¥–∞–Ω–µ
purchase_attrs = %{
  tenant_id: 1,
  period_year: 2025,
  period_month: 10,
  document_date: ~D[2025-10-10],
  tax_event_date: ~D[2025-10-10],
  document_type: "01",
  document_number: "FA-00123",
  supplier_name: "–î–æ—Å—Ç–∞–≤—á–∏–∫ –ï–û–û–î",
  supplier_vat_number: "BG111222333",
  supplier_city: "–í–∞—Ä–Ω–∞",
  taxable_base: Decimal.new("500.00"),
  vat_rate: Decimal.new("20.00"),
  vat_amount: Decimal.new("100.00"),
  total_amount: Decimal.new("600.00"),
  is_deductible: true,
  deductible_credit_type: "full",
  vat_operation_code: "1-10-1",
  column_code: "–ø–æ–∫09"
}

{:ok, purchase} = Repo.insert(
  VatPurchaseRegister.changeset(%VatPurchaseRegister{}, purchase_attrs)
)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ –∏–∑—á–∏—Å–ª—è–≤–∞:
# - deductible_vat_amount: 100.00
```

### –ü—Ä–∏–º–µ—Ä 4: –í–û–ü (–≤—ä—Ç—Ä–µ–æ–±—â–Ω–æ—Å—Ç–Ω–∞ –ø–æ–∫—É–ø–∫–∞)

```elixir
# –ü–æ–∫—É–ø–∫–∞ –æ—Ç –ï–° —Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞—á–∏—Å–ª—è–≤–∞–Ω–µ
purchase_attrs = %{
  tenant_id: 1,
  period_year: 2025,
  period_month: 10,
  document_date: ~D[2025-10-12],
  tax_event_date: ~D[2025-10-12],
  document_type: "01",
  document_number: "INV-456",
  supplier_name: "EU Supplier SRL",
  supplier_vat_number: "RO12345678",
  supplier_country: "RO",
  taxable_base: Decimal.new("3000.00"),
  vat_rate: Decimal.new("20.00"),
  vat_amount: Decimal.new("600.00"),
  total_amount: Decimal.new("3600.00"),
  is_deductible: true,
  deductible_credit_type: "full",
  vat_operation_code: "1-11",
  column_code: "–ø–æ–∫09",
  vies_indicator: "–∫4"
}

{:ok, purchase} = Repo.insert(
  VatPurchaseRegister.changeset(%VatPurchaseRegister{}, purchase_attrs)
)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
# - deductible_vat_amount: 600.00
# - vies_indicator: "–∫4"
```

### –ü—Ä–∏–º–µ—Ä 5: –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –∏ –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ NAP —Ñ–∞–π–ª–æ–≤–µ

```elixir
# –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ –∑–∞ –ù–ê–ü –∑–∞ –æ–∫—Ç–æ–º–≤—Ä–∏ 2025
{:ok, files} = NapExport.generate_nap_files(1, 2025, 10, "/tmp")

IO.puts("DEKLAR.TXT: #{files.deklar}")
IO.puts("POKUPKI.TXT: #{files.pokupki}")
IO.puts("PRODAGBI.TXT: #{files.prodagbi}")

# –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ DEKLAR.TXT
File.read!(files.deklar) |> IO.puts()

# –ü—Ä–∏–º–µ—Ä –∏–∑—Ö–æ–¥:
# BG123456789    –ú–æ—è—Ç–∞ —Ñ–∏—Ä–º–∞ –ï–û–û–î                                 202510...
```

---

## –ò–∑–≤–µ—Å—Ç–Ω–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ TODO

### üöß –í –ø—Ä–æ—Ü–µ—Å –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:

1. **cp-1251 Encoding**
   - –§–∞–π–ª–æ–≤–µ—Ç–µ –≤ –º–æ–º–µ–Ω—Ç–∞ —Å–∞ –≤ UTF-8
   - –¢—Ä—è–±–≤–∞ –¥–∞ —Å–µ –¥–æ–±–∞–≤–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `codepagex` –∑–∞ windows-1251 encoding
   - –§—É–Ω–∫—Ü–∏—è `encode_windows1251/1` –µ placeholder

2. **–ß–∞—Å—Ç–∏—á–µ–Ω –¥–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç**
   - –õ–∏–ø—Å–≤–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ –∏–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –∫–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏ —Å–º–µ—Å–µ–Ω–∞ –¥–µ–π–Ω–æ—Å—Ç
   - –í –º–æ–º–µ–Ω—Ç–∞ –∫–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç—ä—Ç –µ —Ñ–∏–∫—Å–∏—Ä–∞–Ω –Ω–∞ 1.00

3. **–ì–æ–¥–∏—à–Ω–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–µ**
   - –ü–æ–ª–µ 03-43 –∏ 01-43 —Å–∞ –≤–∏–Ω–∞–≥–∏ 0.00
   - –¢—Ä—è–±–≤–∞ –ª–æ–≥–∏–∫–∞ –∑–∞ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–µ –ø–æ —á–ª. 73, –ø–∞—Ä. 8

4. **API endpoints –∑–∞ –î–î–°**
   - –õ–∏–ø—Å–≤–∞—Ç RESTful endpoints –∑–∞ —Ä–∞–±–æ—Ç–∞ —Å –î–î–° —Ä–µ–≥–∏—Å—Ç—Ä–∏
   - –ü–ª–∞–Ω–∏—Ä–∞–Ω–∏: `/api/vat/*`

5. **–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –î–î–° –Ω–æ–º–µ—Ä–∞**
   - –õ–∏–ø—Å–≤–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ VIES —Å–∏—Å—Ç–µ–º–∞ (checksum)
   - –°–∞–º–æ —Ñ–æ—Ä–º–∞—Ç–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è

6. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –≥—Ä–∞–¥**
   - –ü—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏ –æ—Ç —Ñ–∞–∫—Ç—É—Ä–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –≤–∑–∏–º–∞ –≥—Ä–∞–¥—ä—Ç –æ—Ç contacts

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ñ–∞–π–ª–æ–≤–µ—Ç–µ

```
apps/cyber_core/
‚îú‚îÄ‚îÄ lib/cyber_core/
‚îÇ   ‚îú‚îÄ‚îÄ accounting/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat.ex                      # Context –∑–∞ –î–î–° —Å–ø—Ä–∞–≤–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_return.ex               # Schema –∑–∞ –î–î–° —Å–ø—Ä–∞–≤–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_sales_register.ex       # Schema –∑–∞ –¥–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_purchase_register.ex    # Schema –∑–∞ –¥–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_operation_code.ex       # Schema –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nap_export.ex               # NAP —Ñ–∞–π–ª–æ–≤–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ company_settings.ex         # Schema –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ settings.ex                     # Context –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ priv/repo/migrations/
‚îÇ   ‚îú‚îÄ‚îÄ *_create_vat_registers.exs
‚îÇ   ‚îú‚îÄ‚îÄ *_add_detailed_vat_fields.exs
‚îÇ   ‚îú‚îÄ‚îÄ *_create_vat_operation_codes.exs
‚îÇ   ‚îú‚îÄ‚îÄ *_create_company_settings.exs
‚îÇ   ‚îî‚îÄ‚îÄ *_add_city_to_vat_registers.exs
‚îî‚îÄ‚îÄ test/cyber_core/accounting/
    ‚îî‚îÄ‚îÄ vat_test.exs

apps/cyber_web/
‚îú‚îÄ‚îÄ lib/cyber_web/
‚îÇ   ‚îú‚îÄ‚îÄ live/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_return_live/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ex                # LiveView –∑–∞ –î–î–° —Å–ø—Ä–∞–≤–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_sales_register_live/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ex                # LiveView –∑–∞ –¥–Ω–µ–≤–Ω–∏–∫ –ø—Ä–æ–¥–∞–∂–±–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vat_purchase_register_live/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ex                # LiveView –∑–∞ –¥–Ω–µ–≤–Ω–∏–∫ –ø–æ–∫—É–ø–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings_live/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.ex                # LiveView –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ router.ex
‚îî‚îÄ‚îÄ test/cyber_web/live/
    ‚îî‚îÄ‚îÄ vat_return_live_test.exs

docs/
‚îî‚îÄ‚îÄ VAT-docs.md                         # –¢–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç
```

---

## –†–µ—Å—É—Ä—Å–∏ –∏ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏–∏

### –ó–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª–Ω–∞ –±–∞–∑–∞:
- **–ó–î–î–°** - –ó–∞–∫–æ–Ω –∑–∞ –¥–∞–Ω—ä–∫ –≤—ä—Ä—Ö—É –¥–æ–±–∞–≤–µ–Ω–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç
- **–ü–ü–ó–î–î–°** - –ü—Ä–∞–≤–∏–ª–Ω–∏–∫ –∑–∞ –ø—Ä–∏–ª–∞–≥–∞–Ω–µ –Ω–∞ –ó–î–î–°
- **PPDDS_2025** - –ù–∞—Ä–µ–¥–±–∞ –∑–∞ —É—Å–ª–æ–≤–∏—è—Ç–∞ –∏ —Ä–µ–¥–∞ –∑–∞ –ø–æ–¥–∞–≤–∞–Ω–µ –Ω–∞ –î–î–° –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏

### –¢—ä—Ä–≥–æ–≤—Å–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ (—Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è):
- PDF —Ñ–∞–π–ª–æ–≤–µ –≤ `/home/dvg/z-nim-proloq/cyber_ERP/FILE/vat-nap/`
- PPDDS_2025_.html - –û—Ñ–∏—Ü–∏–∞–ª–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ NAP —Ñ–æ—Ä–º–∞—Ç

### –ö–æ–¥–æ–≤–∞ –±–∞–∑–∞:
- Elixir 1.14+
- Phoenix 1.7+
- Ecto 3.10+
- PostgreSQL 14+

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è—Ç–∞ –Ω–∞ –î–î–° –≤ Cyber ERP –ø–æ–∫—Ä–∏–≤–∞ –æ—Å–Ω–æ–≤–Ω–∏—Ç–µ –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–æ—Ç–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—Å—Ç–≤–æ:

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–æ–¥–µ–Ω–µ –Ω–∞ –¥–Ω–µ–≤–Ω–∏—Ü–∏
‚úÖ –í—Å–∏—á–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–¥–æ–≤–µ
‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ NAP —Ñ–∞–π–ª–æ–≤–µ
‚úÖ Multi-tenant –ø–æ–¥–¥—Ä—ä–∂–∫–∞
‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞

**–°–ª–µ–¥–≤–∞—â–∏ —Å—Ç—ä–ø–∫–∏:**
1. –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ cp-1251 encoding
2. –ò–∑–≥—Ä–∞–∂–¥–∞–Ω–µ –Ω–∞ API endpoints
3. –¢–µ—Å—Ç–≤–∞–Ω–µ —Å —Ä–µ–∞–ª–Ω–∏ –¥–∞–Ω–Ω–∏
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ —Å –ù–ê–ü
5. –ß–∞—Å—Ç–∏—á–µ–Ω –¥–∞–Ω—ä—á–µ–Ω –∫—Ä–µ–¥–∏—Ç –∏ –∫–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç
6. –ì–æ–¥–∏—à–Ω–æ –∫–æ—Ä–∏–≥–∏—Ä–∞–Ω–µ

---

**–î–æ–∫—É–º–µ–Ω—Ç—ä—Ç –µ –∞–∫—Ç—É–∞–ª–µ–Ω –∫—ä–º:** 2025-10-11

**–ê–≤—Ç–æ—Ä:** Claude (AI –∞—Å–∏—Å—Ç–µ–Ω—Ç)

**–í–µ—Ä—Å–∏—è:** 1.0
