# Модул за управление на продукти и номенклатури

Този модул реализира пълноценна система за управление на продукти, съвместима със SAF-T и Intrastat изисквания.

## Основни компоненти

### 1. Product (Продукт)
Основна схема за продукти/артикули с поддръжка на:
- Основни данни (име, код, описание, категория)
- Ценообразуване (цена, себестойност, ДДС ставка)
- Складово управление (количество, проследяване)
- Връзка към счетоводна сметка
- **Връзка към КН номенклатура** (cn_code_id)
- **Мулти мерни единици** (has_many :product_units)

Файл: `lib/cyber_core/inventory/product.ex`

### 2. CnNomenclature (Комбинирана номенклатура КН8)
Система за поддръжка на Комбинираната номенклатура по години.
- Код по КН (напр. "01012100")
- Описание на стоката
- Година на валидност
- Основна мерна единица
- Допълнителна мерна единица

Файл: `lib/cyber_core/inventory/cn_nomenclature.ex`

**Важно:** Номенклатурата се поддържа по години, тъй като кодовете и описанията могат да се променят всяка година.

### 3. MeasurementUnit (Мерна единица)
Стандартизирани мерни единици съгласно SAF-T изисквания:
- Код (напр. "kg", "l", "p/st")
- Наименование на BG и EN
- Символ
- Флаг дали е базова единица

Файл: `lib/cyber_core/inventory/measurement_unit.ex`

**Стандартни единици:**
- Маса: kg, g, t
- Обем: l, ml, hl
- Дължина: m, cm, mm, km
- Площ: m², cm², ha
- Обем: m³, cm³
- Брой: бр., двойка, комплект, дузина
- Опаковки: пакет, кутия, палет, торба, бутилка
- Енергия: kWh, MWh
- Време: час, ден, месец

### 4. ProductUnit (Мулти мерни единици за продукт)
Позволява един продукт да има множество мерни единици с коефициенти за конверсия.

**Пример:**
```elixir
# Продукт: Мляко
product_units = [
  %{measurement_unit: "l", conversion_factor: 1.0, is_primary: true},
  %{measurement_unit: "box", conversion_factor: 12.0, barcode: "5449000000996"},  # кутия 12x1л
  %{measurement_unit: "pallet", conversion_factor: 720.0}  # палет 60 кутии
]
```

Файл: `lib/cyber_core/inventory/product_unit.ex`

### 5. CnImporter (Импортер на КН номенклатура)
Утилита за импорт на Комбинирана номенклатура от CSV файл.

Файл: `lib/cyber_core/inventory/cn_importer.ex`

## Миграции

Създадени са следните миграции:

1. **create_cn_nomenclatures** - Таблица за КН номенклатура
2. **create_measurement_units** - Таблица за мерни единици
3. **create_product_units** - Връзка продукт-мерна единица
4. **add_cn_code_to_products** - Добавя cn_code_id към products

## Seed данни

### Стандартни мерни единици
Зарежда стандартните мерни единици за всички тенанти:

```bash
mix run priv/repo/seeds/measurement_units.exs
```

### КН номенклатура 2025
Импортира Комбинирана номенклатура от CSV:

```bash
mix run priv/repo/seeds/cn_nomenclature_2025.exs
```

## Използване

### Създаване на продукт с мулти мерни единици

```elixir
# 1. Създай продукт
product = %Product{
  tenant_id: tenant.id,
  name: "Мляко 3.5%",
  sku: "MILK-001",
  category: "goods",
  cn_code_id: cn_code.id  # Връзка към КН код
}
|> Repo.insert!()

# 2. Създай основна мерна единица
unit_liter = Repo.get_by(MeasurementUnit, tenant_id: tenant.id, code: "l")

%ProductUnit{
  product_id: product.id,
  measurement_unit_id: unit_liter.id,
  conversion_factor: Decimal.new(1),
  is_primary: true
}
|> Repo.insert!()

# 3. Добави допълнителна мерна единица (кутия)
unit_box = Repo.get_by(MeasurementUnit, tenant_id: tenant.id, code: "box")

%ProductUnit{
  product_id: product.id,
  measurement_unit_id: unit_box.id,
  conversion_factor: Decimal.new(12),  # 1 кутия = 12 литра
  barcode: "5449000000996"
}
|> Repo.insert!()
```

### Конвертиране между мерни единици

```elixir
# Имаме 5 кутии, колко литра са?
from_unit = %ProductUnit{conversion_factor: Decimal.new(12)}  # кутия
to_unit = %ProductUnit{conversion_factor: Decimal.new(1)}     # литър

quantity = Decimal.new(5)
result = ProductUnit.convert(from_unit, to_unit, quantity)
# => 60 литра
```

### Търсене на продукт по КН код

```elixir
# Търсене на КН код за 2025 г.
cn_code = Repo.get_by(CnNomenclature, code: "01012100", year: 2025)

# Всички продукти с този КН код
products = Repo.all(
  from p in Product,
  where: p.cn_code_id == ^cn_code.id,
  preload: [:cn_code, :product_units]
)
```

## SAF-T съвместимост

Системата поддържа следните SAF-T изисквания:

1. ✅ **Номенклатура на мерни единици** - Стандартизирани кодове
2. ✅ **Комбинирана номенклатура КН8** - По години
3. ✅ **Мулти мерни единици** - С коефициенти за конверсия
4. ✅ **Връзка продукт-сметка** - За счетоводно отчитане
5. ✅ **Баркодове** - Както на продукт, така и на единица

## Интрастат съвместимост

За нуждите на Интрастат декларацията, системата използва следния механизъм:

- **Продукт и КН код:** Всеки продукт, който е обект на Интрастат отчитане, трябва да бъде свързан с код от Комбинираната номенклатура (КН) чрез полето `cn_code_id`.
- **Свързване на документи и счетоводни записи:** Когато се създава счетоводен запис (`JournalEntry`) от документ за продажба или покупка (`Sales.Invoice` или `Purchase.SupplierInvoice`), записът се свързва с оригиналния документ чрез полетата `source_document_id` и `source_document_type`.
- **Връзка до конкретен ред:** Всеки ред от счетоводния запис (`EntryLine`) се свързва със съответния ред от фактурата (`InvoiceLine` или `SupplierInvoiceLine`) чрез полето `reference_id`.
- **Генериране на декларация:** `Intrastat` модулът използва тези връзки, за да проследи от счетоводния запис до оригиналния продукт и да извлече неговия `cn_code` за декларацията.

Този подход гарантира, че Intrastat кодът е асоцииран единствено с продукта, а не със счетоводната сметка, като същевременно позволява автоматичното генериране на Intrastat декларации.

## Бъдещи разширения

- [ ] История на промени в КН номенклатура
- [ ] Автоматично предложение на КН код по описание
- [ ] Валидация на баркодове (EAN-13, UPC и др.)
- [ ] Експорт на продукти в SAF-T XML формат
- [ ] Интеграция с Интрастат модул
